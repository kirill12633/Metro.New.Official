<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Error Reporter</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
#errorBtn{
  position:fixed;bottom:20px;right:20px;padding:10px 14px;
  border-radius:8px;border:none;background:#ff4d4f;color:#fff;
  cursor:pointer;z-index:9999
}
#errorModal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
  align-items:center;justify-content:center;z-index:10000
}
#errorBox{
  background:#fff;padding:20px;border-radius:12px;width:320px;
  font-family:sans-serif
}
</style>
</head>
<body>

<!-- ================== üî¥ –ò–ó–ú–ï–ù–ò –≠–¢–û üî¥ ================== -->
<script>
const SUPABASE_URL = "https://ackrvfonntcpccrnkcvh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFja3J2Zm9ubnRjcGNjcm5rY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTg5NTMsImV4cCI6MjA4NzE5NDk1M30.Smi844fLUN3rGLRGp-yHeNIT6tn8M-TtjBeh__Lz6aw";
const BUCKET_NAME = "error-screenshots";
</script>

<script>
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ======================================================
   üõ°Ô∏è –ê–ù–¢–ò-–°–ü–ê–ú
====================================================== */
const RATE_LIMIT_SECONDS = 60;
const LS_LAST_SENT = "err_last_sent";
const LS_LAST_HASH = "err_last_hash";

function hashString(str){
  let h=0,i,chr;
  if(str.length===0) return h;
  for(i=0;i<str.length;i++){
    chr=str.charCodeAt(i);
    h=((h<<5)-h)+chr;
    h|=0;
  }
  return h.toString();
}
function canSendNow(){
  const last = Number(localStorage.getItem(LS_LAST_SENT)||0);
  return Date.now()-last > RATE_LIMIT_SECONDS*1000;
}
function markSent(){ localStorage.setItem(LS_LAST_SENT, Date.now().toString()); }

/* ======================================================
   üì∏ SCREENSHOT
====================================================== */
async function takeScreenshot(){
  const canvas = await html2canvas(document.body,{useCORS:true,logging:false,scale:1});
  return new Promise(res=>canvas.toBlob(res,"image/png",0.9));
}

/* ======================================================
   ‚òÅÔ∏è UPLOAD
====================================================== */
async function uploadScreenshot(blob){
  if(!blob) return null;
  if(blob.size>2*1024*1024) return null;
  const path=`errors/${crypto.randomUUID()}.png`;
  const {error}=await supabase.storage.from(BUCKET_NAME).upload(path,blob,{contentType:"image/png"});
  if(error){console.error(error);return null;}
  return path;
}

/* ======================================================
   üóÑÔ∏è SAVE (–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
====================================================== */
async function saveErrorReport({message,screenshotPath}){
  const payload={
    url:location.pathname,
    message,
    error_code:"USER_REPORT",
    error_type:"client",
    screenshot_path:screenshotPath,
    user_agent:navigator.userAgent.slice(0,120)
  };
  const {error}=await supabase.from("error_reports").insert([payload]);
  if(error) throw error;
}

/* ======================================================
   üöÄ MAIN FLOW
====================================================== */
async function reportErrorFlow(text){
  // üõ°Ô∏è honeypot
  if(document.getElementById("hp_field").value){console.warn("bot detected");return;}
  if(!canSendNow()){ setStatus("‚è≥ –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π"); return;}
  const hash=hashString(text);
  if(hash===localStorage.getItem(LS_LAST_HASH)){ setStatus("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏"); return;}

  try{
    setStatus("–î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω‚Ä¶");
    const blob=await takeScreenshot();
    setStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶");
    const path=await uploadScreenshot(blob);
    setStatus("–°–æ—Ö—Ä–∞–Ω—è–µ–º‚Ä¶");
    await saveErrorReport({message:text,screenshotPath:path});
    markSent();
    localStorage.setItem(LS_LAST_HASH,hash);
    setStatus("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    setTimeout(closeErrorDialog,1200);
  }catch(e){
    console.error(e);
    setStatus("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
  }
}

/* ======================================================
   üé® UI
====================================================== */
window.openErrorDialog = function(){ document.getElementById("errorModal").style.display="flex"; };
window.closeErrorDialog = function(){ document.getElementById("errorModal").style.display="none"; };
function setStatus(t){document.getElementById("errorStatus").innerText=t;}
async function submitError(){
  const t=document.getElementById("errorText").value.trim();
  if(!t){alert("–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É");return;}
  await reportErrorFlow(t);
}
</script>

<!-- ================== –ö–ù–û–ü–ö–ê ================== -->
<button id="errorBtn" onclick="openErrorDialog()">–°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ</button>

<!-- ================== –ú–û–î–ê–õ–ö–ê ================== -->
<div id="errorModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:10000">
  <div style="background:#fff;padding:20px;border-radius:12px;width:320px;font-family:sans-serif">
    <h3 style="margin-top:0">–°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ</h3>

    <!-- honeypot -->
    <input id="hp_field" style="display:none" autocomplete="off">

    <textarea id="errorText" placeholder="–ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫?" style="width:100%;height:90px;margin-bottom:10px;"></textarea>

    <div id="errorStatus" style="font-size:12px;color:#666;margin-bottom:10px;"></div>

    <div style="display:flex;gap:8px;">
      <button onclick="submitError()" style="flex:1;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button onclick="closeErrorDialog()" style="flex:1;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

</body>
</html>
