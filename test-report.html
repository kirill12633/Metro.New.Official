<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Test Report</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- Кнопка -->
<button onclick="openErrorDialog()">Сообщить об ошибке</button>

<!-- Модалка -->
<div id="errorModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:10000">
  <div style="background:#fff;padding:20px;width:300px;border-radius:12px">
    <textarea id="errorText" placeholder="Что пошло не так?" style="width:100%;height:90px;"></textarea>
    <button onclick="submitError()">Отправить</button>
    <button onclick="closeErrorDialog()">Отмена</button>
  </div>
</div>

<script>
// ================== Supabase ==================
if(!window.supabaseClient){
  window.supabaseClient = supabase.createClient(
    "https://ackrvfonntcpccrnkcvh.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFja3J2Zm9ubnRjcGNjcm5rY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTg5NTMsImV4cCI6MjA4NzE5NDk1M30.Smi844fLUN3rGLRGp-yHeNIT6tn8M-TtjBeh__Lz6aw"
  );
}
const supabase = window.supabaseClient;

// ================== UI ==================
window.openErrorDialog = function(){ document.getElementById("errorModal").style.display="flex"; };
window.closeErrorDialog = function(){ document.getElementById("errorModal").style.display="none"; };

// ================== Минимальный flow ==================
async function takeScreenshot(){
  const canvas = await html2canvas(document.body);
  return new Promise(res => canvas.toBlob(res,"image/png"));
}

async function uploadScreenshot(blob){
  if(!blob) return null;
  const path = `errors/${crypto.randomUUID()}.png`;
  const {error} = await supabase.storage.from("error-screenshots").upload(path,blob,{contentType:"image/png"});
  if(error){console.error(error); return null;}
  return path;
}

async function saveErrorReport({message,screenshotPath}){
  await supabase.from("error_reports").insert([{
    url:location.pathname,
    message,
    error_code:"USER_REPORT",
    error_type:"client",
    screenshot_path:screenshotPath,
    user_agent:navigator.userAgent
  }]);
}

async function submitError(){
  const text = document.getElementById("errorText").value.trim();
  if(!text) { alert("Опишите проблему"); return; }
  const blob = await takeScreenshot();
  const path = await uploadScreenshot(blob);
  await saveErrorReport({message:text,screenshotPath:path});
  alert("Отправлено!");
  closeErrorDialog();
}
</script>

</body>
</html>
