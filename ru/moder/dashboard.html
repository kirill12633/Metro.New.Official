<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Metro New Admin</title>
    
    <!-- Иконки -->
    <link rel="shortcut icon" href="https://kirill12633.github.io/Metro.New.Official/ru/images/metro-icon.png" type="image/png">
    <link rel="apple-touch-icon" href="https://kirill12633.github.io/Metro.New.Official/ru/images/metro-icon.png">
    
    <!-- Шрифты и иконки -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js"></script>

    <style>
        /* Стили из предыдущего dashboard.html */
        :root {
            --primary: #0066CC;
            --primary-dark: #0052a3;
            --secondary: #FFD700;
            --dark: #1A1A1A;
            --light: #F8F9FA;
            --gray: #6C757D;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --admin-bg: #1a1a2e;
            --admin-sidebar: #16213e;
            --admin-card: #0f3460;
            --metro-red: #D52B1E;
            --metro-blue: #0078BE;
            --metro-green: #009D58;
        }
        
        /* ... остальные стили ... */
    </style>
</head>
<body>
    <!-- Нотификации -->
    <div class="notification" id="notification"></div>
    
    <!-- Загрузочный экран -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h3 id="loadingText">Загрузка данных...</h3>
    </div>
    
    <div class="admin-container" id="adminContainer" style="display: none;">
        <!-- Сайдбар -->
        <div class="admin-sidebar">
            <div class="admin-logo">
                <div class="admin-logo-icon">M</div>
                <div class="admin-logo-text">
                    <div>Metro New</div>
                    <div style="font-size: 0.9rem; color: var(--secondary);">Admin Panel</div>
                </div>
            </div>
            
            <!-- Информация о пользователе -->
            <div class="admin-user-info" id="userInfo">
                <div class="user-detail">
                    <span class="user-detail-label">Пользователь:</span>
                    <span class="user-detail-value" id="userEmail">-</span>
                </div>
                <div class="user-detail">
                    <span class="user-detail-label">Роль:</span>
                    <span class="user-detail-value" id="userRole">-</span>
                </div>
                <div class="user-detail">
                    <span class="user-detail-label">IP:</span>
                    <span class="user-detail-value" id="userIP">-</span>
                </div>
            </div>
            
            <!-- Навигация -->
            <nav class="admin-nav">
                <a href="#dashboard" class="nav-item active" onclick="loadSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Дашборд
                </a>
                <a href="#complaints" class="nav-item" onclick="loadSection('complaints')">
                    <i class="fas fa-exclamation-triangle"></i> Жалобы
                    <span class="badge" id="complaintsBadge">0</span>
                </a>
                <a href="#queue" class="nav-item" onclick="loadSection('queue')">
                    <i class="fas fa-hourglass-half"></i> Очередь
                    <span class="badge" id="queueBadge">0</span>
                </a>
                <a href="#users" class="nav-item" onclick="loadSection('users')">
                    <i class="fas fa-users"></i> Пользователи
                </a>
                <a href="#banned" class="nav-item" onclick="loadSection('banned')">
                    <i class="fas fa-ban"></i> Блокировки
                </a>
                <a href="#reports" class="nav-item" onclick="loadSection('reports')">
                    <i class="fas fa-chart-bar"></i> Отчёты
                </a>
                <a href="#logs" class="nav-item" onclick="loadSection('logs')">
                    <i class="fas fa-history"></i> Логи
                </a>
                <a href="#settings" class="nav-item" onclick="loadSection('settings')">
                    <i class="fas fa-cog"></i> Настройки
                </a>
            </nav>
            
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Выйти
            </button>
        </div>
        
        <!-- Основной контент -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
            </header>
            
            <div id="contentArea">
                <!-- Контент будет загружаться здесь -->
            </div>
        </main>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAVSAXTU1VqF36GJA1pQOfxRxo3_ixW7F4",
            authDomain: "metro-new-admin.firebaseapp.com",
            projectId: "metro-new-admin",
            storageBucket: "metro-new-admin.firebasestorage.app",
            messagingSenderId: "769002010414",
            appId: "1:769002010414:web:bdeb93a7eddc4cab63ecbf"
        };

        // Инициализация Firebase с App Check
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            
            // Активация App Check
            const appCheck = firebase.appCheck();
            appCheck.activate('6LcC3s0pAAAAAJjQHG3e9_2R0wKZ8g9d7b7gXqX7', true);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Проверка авторизации
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Проверяем роль пользователя
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    await auth.signOut();
                    window.location.href = 'login.html';
                    return;
                }
                
                const userData = userDoc.data();
                
                // Проверка роли
                if (userData.role !== 'admin' && userData.role !== 'moder') {
                    await auth.signOut();
                    window.location.href = 'login.html';
                    return;
                }
                
                // Обновляем информацию о пользователе
                updateUserInfo(user, userData);
                
                // Показываем панель
                document.getElementById('adminContainer').style.display = 'flex';
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Загружаем начальную секцию
                loadSection('dashboard');
                
                // Загружаем уведомления
                loadNotifications();
                
                // Логируем вход
                await logAction('login', 'success', 'Вход в админ-панель');
                
            } catch (error) {
                console.error('Ошибка проверки доступа:', error);
                window.location.href = 'login.html';
            }
        });
        
        // Функции для работы с админ-панелью
        async function loadSection(section) {
            // Обновляем активный пункт меню
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Показываем загрузку
            showLoading();
            
            try {
                let content = '';
                
                switch(section) {
                    case 'dashboard':
                        content = await loadDashboard();
                        document.getElementById('pageTitle').textContent = 'Dashboard';
                        break;
                    case 'complaints':
                        content = await loadComplaints();
                        document.getElementById('pageTitle').textContent = 'Жалобы';
                        break;
                    case 'queue':
                        content = await loadQueue();
                        document.getElementById('pageTitle').textContent = 'Очередь одобрения';
                        break;
                    case 'users':
                        content = await loadUsers();
                        document.getElementById('pageTitle').textContent = 'Пользователи';
                        break;
                    case 'banned':
                        content = await loadBannedUsers();
                        document.getElementById('pageTitle').textContent = 'Блокировки';
                        break;
                    case 'reports':
                        content = await loadReports();
                        document.getElementById('pageTitle').textContent = 'Отчёты';
                        break;
                    case 'logs':
                        content = await loadLogs();
                        document.getElementById('pageTitle').textContent = 'Логи действий';
                        break;
                    case 'settings':
                        content = await loadSettings();
                        document.getElementById('pageTitle').textContent = 'Настройки';
                        break;
                }
                
                document.getElementById('contentArea').innerHTML = content;
                
            } catch (error) {
                console.error('Ошибка загрузки секции:', error);
                showNotification('Ошибка загрузки данных', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Загрузка Dashboard
        async function loadDashboard() {
            const stats = await getStats();
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${stats.totalUsers}</h3>
                        <p>Пользователей</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.activeUsers}</h3>
                        <p>Онлайн</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.pendingComplaints}</h3>
                        <p>Жалоб</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.queueItems}</h3>
                        <p>В очереди</p>
                    </div>
                </div>
                
                <div class="recent-activity">
                    <h3>Последние действия</h3>
                    ${await getRecentActivity()}
                </div>
            `;
        }
        
        // Получение статистики
        async function getStats() {
            // Здесь реализация запросов к Firestore
            return {
                totalUsers: 1024,
                activeUsers: 156,
                pendingComplaints: 23,
                queueItems: 15
            };
        }
        
        // Выход из системы
        async function logout() {
            try {
                await logAction('logout', 'info', 'Выход из системы');
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Ошибка выхода:', error);
            }
        }
        
        // Другие функции...
        
    </script>
</body>
</html>
