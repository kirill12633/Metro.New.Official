<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1Metro Security Docs | –í—Ö–æ–¥</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="assets/logo.png">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="assets/logo.png" alt="Logo" class="login-logo">
                <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                <p>–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –º–µ—Ç—Ä–æ–ø–æ–ª–∏—Ç–µ–Ω–∞</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                    <input type="email" id="email" required 
                           placeholder="ivanov@metro-security.ru"
                           pattern="^[a-zA-Z0-9._%+-]+@metro-security\.ru$"
                           title="–¢–æ–ª—å–∫–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ email @metro-security.ru">
                </div>

                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <div class="password-container">
                        <input type="password" id="password" required 
                               minlength="8" maxlength="32"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –≤—ã–¥–∞–Ω–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º">
                        <button type="button" class="toggle-password" id="togglePassword">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="twoFactorCode">–ö–æ–¥ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</label>
                    <input type="text" id="twoFactorCode" 
                           placeholder="000000" maxlength="6"
                           pattern="[0-9]{6}"
                           title="6-–∑–Ω–∞—á–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –∫–æ–¥">
                    <small class="hint">–ö–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Authenticator –∏–ª–∏ SMS</small>
                </div>

                <div class="form-options">
                    <label class="checkbox">
                        <input type="checkbox" id="rememberMe">
                        <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</span>
                    </label>
                    <button type="button" class="btn-help" id="helpBtn">
                        –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?
                    </button>
                </div>

                <button type="submit" class="btn-login" id="loginBtn">
                    <span id="loginBtnText">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</span>
                    <div class="spinner hidden" id="loginSpinner"></div>
                </button>
                
                <div class="login-footer">
                    <p id="loginMessage" class="message"></p>
                    <p class="system-notice">
                        <strong>–°–∏—Å—Ç–µ–º–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong><br>
                        –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
                    </p>
                </div>
            </form>

            <div class="security-info">
                <h4>üîê –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤—Ö–æ–¥—É:</h4>
                <ol>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π email @metro-security.ru</li>
                    <li>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å, –≤—ã–¥–∞–Ω–Ω—ã–π –æ—Ç–¥–µ–ª–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</li>
                    <li>–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ 2FA –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</li>
                    <li>–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</li>
                    <li>–ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</li>
                </ol>
                
                <div class="emergency-contact">
                    <h5>üìû –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç:</h5>
                    <p>–û—Ç–¥–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: <strong>+7 (XXX) XXX-XX-XX</strong></p>
                    <p>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: <strong>support@metro-security.ru</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏ -->
    <div id="helpModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ü–æ–º–æ—â—å –ø–æ –≤—Ö–æ–¥—É –≤ —Å–∏—Å—Ç–µ–º—É</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <h4>–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4>
                
                <div class="problem">
                    <h5>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å</h5>
                    <p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π email —Ñ–æ—Ä–º–∞—Ç–∞ name@metro-security.ru</p>
                </div>
                
                <div class="problem">
                    <h5>üîê –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å</h5>
                    <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è</p>
                </div>
                
                <div class="problem">
                    <h5>üì± –ü—Ä–æ–±–ª–µ–º—ã —Å 2FA</h5>
                    <p>–ï—Å–ª–∏ —É—Ç–µ—Ä—è–Ω –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–¥ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
                </div>
                
                <div class="problem">
                    <h5>üö´ –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h5>
                    <p>–ü–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ –∞–∫–∫–∞—É–Ω—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 30 –º–∏–Ω—É—Ç</p>
                </div>
                
                <div class="contact-info">
                    <h5>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–º–æ—â–∏:</h5>
                    <ul>
                        <li><strong>–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞:</strong> support@metro-security.ru</li>
                        <li><strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> security@metro-security.ru</li>
                        <li><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> +7 (XXX) XXX-XX-XX (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
    authDomain: "metro-new-85226.firebaseapp.com",
    databaseURL: "https://metro-new-85226-default-rtdb.firebaseio.com",
    projectId: "metro-new-85226",
    storageBucket: "metro-new-85226.firebasestorage.app",
    messagingSenderId: "905640751733",
    appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
    };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        let loginAttempts = 0;
        const MAX_ATTEMPTS = 5;
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginMessage = document.getElementById('loginMessage');
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
        });
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏
        helpBtn.addEventListener('click', function() {
            helpModal.classList.remove('hidden');
        });
        
        document.querySelector('.close-modal').addEventListener('click', function() {
            helpModal.classList.add('hidden');
        });
        
        // –ö–ª–∏–∫ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.addEventListener('click', function(event) {
            if (event.target === helpModal) {
                helpModal.classList.add('hidden');
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const twoFactorCode = document.getElementById('twoFactorCode').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è email
            if (!email.endsWith('@metro-security.ru')) {
                showMessage('–¢–æ–ª—å–∫–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ email @metro-security.ru —Ä–∞–∑—Ä–µ—à–µ–Ω—ã', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫
            if (loginAttempts >= MAX_ATTEMPTS) {
                showMessage('–ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.', 'error');
                await logSecurityEvent('blocked_account', email, '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            setLoading(true);
            
            try {
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ persistence
                const persistence = rememberMe ? 
                    firebase.auth.Auth.Persistence.LOCAL : 
                    firebase.auth.Auth.Persistence.SESSION;
                
                await auth.setPersistence(persistence);
                
                // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Firestore
                const userDoc = await db.collection('metro-security-docs')
                    .doc('system')
                    .collection('users')
                    .doc(user.uid)
                    .get();
                
                if (!userDoc.exists) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ - —É–¥–∞–ª—è–µ–º –∏–∑ auth
                    await user.delete();
                    throw new Error('–£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
                }
                
                const userData = userDoc.data();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
                if (!userData.active) {
                    throw new Error('–ê–∫–∫–∞—É–Ω—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2FA –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
                if (userData.twoFactorEnabled && twoFactorCode) {
                    const isValid = await verifyTwoFactor(user.uid, twoFactorCode);
                    if (!isValid) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                    }
                } else if (userData.twoFactorEnabled && !twoFactorCode) {
                    throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–¥ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥
                await db.collection('metro-security-docs')
                    .doc('system')
                    .collection('users')
                    .doc(user.uid)
                    .update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        loginCount: (userData.loginCount || 0) + 1
                    });
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å —Å–µ—Å—Å–∏–∏
                await createSession(user.uid, email);
                
                // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                await logAuditEvent(user.uid, email, 'login_success', '–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
                loginAttempts = 0;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                showMessage('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...', 'success');
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
                setTimeout(() => {
                    if (userData.role === 'admin') {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'viewer.html';
                    }
                }, 1500);
                
            } catch (error) {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
                loginAttempts++;
                
                // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                await logSecurityEvent('login_failed', email, error.message);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
                        break;
                    case 'auth/user-disabled':
                        errorMessage += '–ê–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
                
                // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å 1 –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
                if (MAX_ATTEMPTS - loginAttempts === 1) {
                    showMessage('–í–Ω–∏–º–∞–Ω–∏–µ! –ü–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                }
                
            } finally {
                setLoading(false);
            }
        });
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function setLoading(isLoading) {
            if (isLoading) {
                loginBtn.disabled = true;
                loginBtnText.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...';
                loginSpinner.classList.remove('hidden');
            } else {
                loginBtn.disabled = false;
                loginBtnText.textContent = '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
                loginSpinner.classList.add('hidden');
            }
        }
        
        function showMessage(text, type) {
            loginMessage.textContent = text;
            loginMessage.className = 'message ' + type;
            loginMessage.style.display = 'block';
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (type === 'success') {
                setTimeout(() => {
                    loginMessage.style.display = 'none';
                }, 3000);
            }
        }
        
        async function verifyTwoFactor(userId, code) {
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—Å—Ç–æ—è—â–µ–π 2FA —Å–∏—Å—Ç–µ–º–æ–π
            // –î–ª—è –¥–µ–º–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–¥ 6 —Ü–∏—Ñ—Ä
            return /^\d{6}$/.test(code);
        }
        
        async function createSession(userId, email) {
            try {
                const ip = await getIPAddress();
                
                const sessionData = {
                    userId: userId,
                    userEmail: email,
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    ipAddress: ip,
                    userAgent: navigator.userAgent,
                    active: true
                };
                
                await db.collection('metro-security-docs')
                    .doc('system')
                    .collection('sessions')
                    .add(sessionData);
                    
            } catch (error) {
                console.error('Error creating session:', error);
            }
        }
        
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }
        
        async function logAuditEvent(userId, userEmail, action, details) {
            try {
                const ip = await getIPAddress();
                
                const auditData = {
                    userId: userId,
                    userEmail: userEmail,
                    action: action,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ipAddress: ip,
                    userAgent: navigator.userAgent
                };
                
                await db.collection('metro-security-docs')
                    .doc('system')
                    .collection('audit_logs')
                    .add(auditData);
                    
            } catch (error) {
                console.error('Error logging audit:', error);
            }
        }
        
        async function logSecurityEvent(eventType, userId, details) {
            try {
                const ip = await getIPAddress();
                
                const securityData = {
                    eventType: eventType,
                    userId: userId,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ipAddress: ip,
                    severity: 'high'
                };
                
                await db.collection('metro-security-docs')
                    .doc('system')
                    .collection('security_events')
                    .add(securityData);
                    
            } catch (error) {
                console.error('Error logging security event:', error);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ
        auth.onAuthStateChanged((user) => {
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                window.location.href = 'viewer.html';
            }
        });
    </script>
    
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .password-container {
            position: relative;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
        }
        
        .hint {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }
        
        .btn-help {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.9em;
            padding: 0;
        }
        
        .btn-help:hover {
            text-decoration: underline;
        }
        
        .system-notice {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 15px;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .problem {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .problem h5 {
            margin-top: 0;
            color: #333;
        }
        
        .contact-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 5px;
        }
        
        .emergency-contact {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }
        
        .emergency-contact h5 {
            margin-top: 0;
            color: #856404;
        }
    </style>
</body>
</html>
