<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Security | –ê–¥–º–∏–Ω</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .user-info {
            text-align: right;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            border-bottom: 3px solid #2980b9;
        }
        
        .content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        
        .stat-card h3 {
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header>
            <div class="logo">
                üöá Metro Security - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            </div>
            <div class="user-info">
                <div id="adminEmail">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">üìä –î–∞—à–±–æ—Ä–¥</div>
            <div class="tab" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="tab" data-tab="documents">üìÅ –î–æ–∫—É–º–µ–Ω—Ç—ã</div>
            <div class="tab" data-tab="audit">üìã –ê—É–¥–∏—Ç</div>
        </div>
        
        <div class="content">
            <!-- –î–∞—à–±–æ—Ä–¥ -->
            <div id="dashboardTab" class="tab-content active">
                <h2>üìä –î–∞—à–±–æ—Ä–¥ —Å–∏—Å—Ç–µ–º—ã</h2>
                <div class="stats">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div class="stat-number" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
                        <div class="stat-number" id="totalDocuments">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</h3>
                        <div class="stat-number" id="activeSessions">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>–°–æ–±—ã—Ç–∏–π —Å–µ–≥–æ–¥–Ω—è</h3>
                        <div class="stat-number" id="todayEvents">0</div>
                    </div>
                </div>
                
                <div id="dashboardContent">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                </div>
            </div>
            
            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            <div id="usersTab" class="tab-content">
                <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                <button class="btn btn-primary" onclick="showAddUserModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                
                <div id="usersContent">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
                </div>
            </div>
            
            <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã -->
            <div id="documentsTab" class="tab-content">
                <h2>üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏</h2>
                <button class="btn btn-primary" onclick="showAddDocumentModal()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                
                <div id="documentsContent">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</div>
                </div>
            </div>
            
            <!-- –ê—É–¥–∏—Ç -->
            <div id="auditTab" class="tab-content">
                <h2>üìã –°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç–∞</h2>
                
                <div id="auditContent">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <form id="addUserForm">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="newUserEmail" required placeholder="user@metro-security.ru">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="newUserPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>–ò–º—è:</label>
                    <input type="text" id="newUserName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                </div>
                <div class="form-group">
                    <label>–†–æ–ª—å:</label>
                    <select id="newUserRole" required>
                        <option value="viewer">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addUserModal')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
    <div id="addDocumentModal" class="modal">
        <div class="modal-content">
            <h3>üìÅ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h3>
            <form id="addDocumentForm">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" id="docName" required placeholder="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="docDescription" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
                </div>
                <div class="form-group">
                    <label>–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:</label>
                    <select id="docAccess" required>
                        <option value="public">–ü—É–±–ª–∏—á–Ω—ã–π</option>
                        <option value="internal">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π</option>
                        <option value="confidential">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø:</label>
                    <select id="docType" required>
                        <option value="pdf">PDF</option>
                        <option value="docx">Word</option>
                        <option value="jpg">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addDocumentModal')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (—Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ –≤ login.html)
        const firebaseConfig = {
            apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
            authDomain: "metro-new-85226.firebaseapp.com",
            projectId: "metro-new-85226",
            storageBucket: "metro-new-85226.firebasestorage.app",
            messagingSenderId: "905640751733",
            appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        let auth, db;
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω");
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ Firebase:", error);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function checkAdminAccess() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    window.location.href = 'login.html';
                    return false;
                }
                
                console.log("üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", user.email);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        role: 'admin', // –ü–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–¥–º–∏–Ω–æ–º
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –∫–∞–∫ –∞–¥–º–∏–Ω");
                    return true;
                }
                
                const userData = userDoc.data();
                
                if (userData.role !== 'admin') {
                    alert('‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                    window.location.href = 'viewer.html';
                    return false;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º email –≤ —à–∞–ø–∫–µ
                document.getElementById('adminEmail').textContent = user.email;
                return true;
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤:", error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞
        async function loadDashboard() {
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const usersSnapshot = await db.collection('users').get();
                const users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                document.getElementById('totalUsers').textContent = users.length;
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                const docsSnapshot = await db.collection('documents').get();
                document.getElementById('totalDocuments').textContent = docsSnapshot.size;
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                const sessionsSnapshot = await db.collection('sessions')
                    .where('active', '==', true)
                    .get();
                document.getElementById('activeSessions').textContent = sessionsSnapshot.size;
                
                // –°–æ–±—ã—Ç–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const eventsSnapshot = await db.collection('audit_logs')
                    .where('timestamp', '>=', today)
                    .get();
                document.getElementById('todayEvents').textContent = eventsSnapshot.size;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–∞—à–±–æ—Ä–¥–∞
                const dashboardHTML = `
                    <h3>üìà –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${eventsSnapshot.docs.slice(0, 10).map(doc => {
                                const data = doc.data();
                                const time = data.timestamp?.toDate().toLocaleTimeString() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                                return `
                                    <tr>
                                        <td>${time}</td>
                                        <td>${data.userEmail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                        <td>${data.action || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                        <td>${data.ipAddress || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('dashboardContent').innerHTML = dashboardHTML;
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:", error);
                document.getElementById('dashboardContent').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                const usersHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>–ò–º—è</th>
                                <th>–†–æ–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => {
                                const lastLogin = user.lastLogin?.toDate().toLocaleDateString() || '–ù–∏–∫–æ–≥–¥–∞';
                                const status = user.active ? 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' : 'üî¥ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                                
                                return `
                                    <tr>
                                        <td>${user.email}</td>
                                        <td>${user.displayName || '-'}</td>
                                        <td>${user.role}</td>
                                        <td>${status}</td>
                                        <td>${lastLogin}</td>
                                        <td>
                                            <button class="btn btn-success" onclick="editUser('${user.id}')">‚úèÔ∏è</button>
                                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('usersContent').innerHTML = usersHTML;
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
                document.getElementById('usersContent').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        async function loadDocuments() {
            try {
                const snapshot = await db.collection('documents').get();
                const documents = [];
                snapshot.forEach(doc => {
                    documents.push({ id: doc.id, ...doc.data() });
                });
                
                const docsHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–¢–∏–ø</th>
                                <th>–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞</th>
                                <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${documents.map(doc => {
                                const uploadDate = doc.uploadDate?.toDate().toLocaleDateString() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                                const accessLevel = {
                                    'public': 'üåç –ü—É–±–ª–∏—á–Ω—ã–π',
                                    'internal': 'üè¢ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π',
                                    'confidential': 'üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π',
                                    'secret': 'üö´ –°–µ–∫—Ä–µ—Ç–Ω—ã–π',
                                    'top_secret': '‚ö° –°–æ–≤. —Å–µ–∫—Ä–µ—Ç–Ω—ã–π'
                                }[doc.accessLevel] || doc.accessLevel;
                                
                                return `
                                    <tr>
                                        <td>${doc.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
                                        <td>${doc.type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                        <td>${accessLevel}</td>
                                        <td>${uploadDate}</td>
                                        <td>
                                            <button class="btn btn-primary" onclick="viewDocument('${doc.id}')">üëÅÔ∏è</button>
                                            <button class="btn btn-danger" onclick="deleteDocument('${doc.id}')">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('documentsContent').innerHTML = docsHTML;
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:", error);
                document.getElementById('documentsContent').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏—Ç–∞
        async function loadAudit() {
            try {
                const snapshot = await db.collection('audit_logs')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const logs = [];
                snapshot.forEach(doc => {
                    logs.push({ id: doc.id, ...doc.data() });
                });
                
                const auditHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th>IP –∞–¥—Ä–µ—Å</th>
                                <th>–î–µ—Ç–∞–ª–∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(log => {
                                const timestamp = log.timestamp?.toDate().toLocaleString() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                                return `
                                    <tr>
                                        <td>${timestamp}</td>
                                        <td>${log.userEmail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                        <td>${log.action || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                        <td>${log.ipAddress || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                        <td>${log.details || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('auditContent').innerHTML = auditHTML;
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏—Ç–∞:", error);
                document.getElementById('auditContent').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function createUser(email, password, name, role) {
            try {
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ Firestore
                await db.collection('users').doc(user.uid).set({
                    email: email,
                    displayName: name,
                    role: role,
                    active: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: null
                });
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                await db.collection('audit_logs').add({
                    userId: auth.currentUser.uid,
                    userEmail: auth.currentUser.email,
                    action: 'user_created',
                    details: `–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${email} (${role})`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ipAddress: await getIPAddress()
                });
                
                alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${email} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`);
                closeModal('addUserModal');
                loadUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function createDocument(name, description, accessLevel, docType) {
            try {
                const user = auth.currentUser;
                
                await db.collection('documents').add({
                    name: name,
                    description: description,
                    type: docType,
                    accessLevel: accessLevel,
                    uploaderId: user.uid,
                    uploaderEmail: user.email,
                    uploadDate: firebase.firestore.FieldValue.serverTimestamp(),
                    viewCount: 0,
                    lastViewed: null,
                    tags: []
                });
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                await db.collection('audit_logs').add({
                    userId: user.uid,
                    userEmail: user.email,
                    action: 'document_created',
                    details: `–°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç: ${name}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ipAddress: await getIPAddress()
                });
                
                alert(`‚úÖ –î–æ–∫—É–º–µ–Ω—Ç "${name}" —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`);
                closeModal('addDocumentModal');
                loadDocuments(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:", error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showAddUserModal() {
            document.getElementById('addUserForm').reset();
            showModal('addUserModal');
        }
        
        function showAddDocumentModal() {
            document.getElementById('addDocumentForm').reset();
            showModal('addDocumentModal');
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function logout() {
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å...");
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
            const isAdmin = await checkAdminAccess();
            if (!isAdmin) return;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
                    switch(tabId) {
                        case 'dashboard':
                            loadDashboard();
                            break;
                        case 'users':
                            loadUsers();
                            break;
                        case 'documents':
                            loadDocuments();
                            break;
                        case 'audit':
                            loadAudit();
                            break;
                    }
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('addUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('newUserEmail').value;
                const password = document.getElementById('newUserPassword').value;
                const name = document.getElementById('newUserName').value;
                const role = document.getElementById('newUserRole').value;
                
                createUser(email, password, name, role);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
            document.getElementById('addDocumentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('docName').value;
                const description = document.getElementById('docDescription').value;
                const accessLevel = document.getElementById('docAccess').value;
                const docType = document.getElementById('docType').value;
                
                createDocument(name, description, accessLevel, docType);
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            loadDashboard();
        });
    </script>
</body>
</html>
