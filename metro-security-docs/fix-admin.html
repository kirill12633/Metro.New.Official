<!DOCTYPE html>
<html>
<head>
    <title>–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .card { border: 1px solid #ccc; padding: 20px; margin: 10px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    
    <div id="userInfo" class="card">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
    </div>
    
    <div class="card">
        <h3>–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:</h3>
        <input type="email" id="fixEmail" placeholder="admin@metro-security.ru">
        <br><br>
        <select id="fixRole">
            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
            <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
            <option value="viewer">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
        </select>
        <br><br>
        <button onclick="fixUserData()">–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="makeMeAdmin()" style="background: red; color: white;">–°–¥–µ–ª–∞—Ç—å –º–µ–Ω—è –∞–¥–º–∏–Ω–æ–º</button>
    </div>
    
    <div id="result" class="card"></div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
            authDomain: "metro-new-85226.firebaseapp.com",
            projectId: "metro-new-85226",
            storageBucket: "metro-new-85226.firebasestorage.app",
            messagingSenderId: "905640751733",
            appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", user.uid, user.email);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                document.getElementById('userInfo').innerHTML = `
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</h3>
                    <p><strong>ID:</strong> ${user.uid}</p>
                    <p><strong>Email (Auth):</strong> ${user.email || '–ù–µ—Ç'}</p>
                    <p><strong>–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</strong> ${user.providerId}</p>
                `;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    document.getElementById('userInfo').innerHTML += `
                        <h3>–î–∞–Ω–Ω—ã–µ –∏–∑ Firestore:</h3>
                        <p><strong>Email:</strong> ${data.email || '‚ùå –ü–£–°–¢–û!'}</p>
                        <p><strong>–†–æ–ª—å:</strong> ${data.role || '‚ùå –ü–£–°–¢–û!'}</p>
                        <p><strong>–ê–∫—Ç–∏–≤–µ–Ω:</strong> ${data.active ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</p>
                        <p><strong>2FA:</strong> ${data.twoFactorEnabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω'}</p>
                    `;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    document.getElementById('fixEmail').value = data.email || user.email || '';
                    document.getElementById('fixRole').value = data.role || 'admin';
                } else {
                    document.getElementById('userInfo').innerHTML += `
                        <p style="color: red;">‚ùå –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Firestore!</p>
                    `;
                }
                
            } else {
                document.getElementById('userInfo').innerHTML = `
                    <p style="color: red;">‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!</p>
                    <button onclick="window.location.href='login.html'">–í–æ–π—Ç–∏</button>
                `;
            }
        });

        async function fixUserData() {
            const user = auth.currentUser;
            if (!user) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!");
                return;
            }
            
            const newEmail = document.getElementById('fixEmail').value;
            const newRole = document.getElementById('fixRole').value;
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firestore
                await db.collection('users').doc(user.uid).update({
                    email: newEmail,
                    role: newRole,
                    twoFactorEnabled: false,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        ‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!
                        <p><strong>Email:</strong> ${newEmail}</p>
                        <p><strong>–†–æ–ª—å:</strong> ${newRole}</p>
                        <p>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.</p>
                    </div>
                `;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        ‚ùå –û—à–∏–±–∫–∞: ${error.message}
                    </div>
                `;
            }
        }

        async function makeMeAdmin() {
            const user = auth.currentUser;
            if (!user) return;
            
            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å—Ç–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?")) return;
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await db.collection('users').doc(user.uid).update({
                    email: user.email,
                    role: "admin",
                    twoFactorEnabled: false,
                    displayName: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã"
                });
                
                alert("‚úÖ –¢–µ–ø–µ—Ä—å –≤—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                window.location.reload();
                
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º –µ—Å–ª–∏ —É –Ω–µ–≥–æ –ø—É—Å—Ç–∞—è —Ä–æ–ª—å
        async function autoFixIfNeeded() {
            const user = auth.currentUser;
            if (!user) return;
            
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const data = userDoc.data();
                
                // –ï—Å–ª–∏ email –∏–ª–∏ role –ø—É—Å—Ç—ã–µ - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                if (!data.email || !data.role) {
                    console.log("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...");
                    
                    await db.collection('users').doc(user.uid).update({
                        email: user.email || "admin@metro-security.ru",
                        role: data.role || "admin",
                        twoFactorEnabled: false
                    });
                    
                    alert("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!");
                    window.location.reload();
                }
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
        setTimeout(autoFixIfNeeded, 3000);
    </script>
</body>
</html>
