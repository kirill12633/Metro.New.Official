<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход - Метро New</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="nav">
        <div class="container nav-container">
            <div class="logo">
                <span class="logo-icon">M</span>
                <span>Метро New</span>
            </div>
            <div class="nav-links">
                <a href="../../../index.html">Главная</a>
                <a href="../../../game.html">Игра</a>
                <a href="registration.html">Регистрация</a>
            </div>
        </div>
    </nav>

    <main>
        <div class="auth-container">
            <div class="metro-background"></div>
            <div class="card animate-fade-in-up" style="max-width: 500px; margin: 2rem auto;">
                <div class="metro-decoration text-center">
                    <div class="metro-icon">
                        <i class="fas fa-subway"></i>
                    </div>
                    <div class="welcome-text">Добро пожаловать обратно!</div>
                </div>
                
                <div class="auth-header text-center mb-4">
                    <h1>Вход в систему</h1>
                    <p class="text-muted">Войдите в свой аккаунт Метро New</p>
                </div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" class="form-input" id="email" placeholder="Введите ваш email" required>
                        </div>
                        <div class="error-message" id="emailError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-input" id="password" placeholder="Введите ваш пароль" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="passwordError"></div>
                    </div>
                    
                    <div class="form-group d-flex justify-between align-center">
                        <div class="checkbox-group">
                            <input type="checkbox" id="rememberMe">
                            <label for="rememberMe">Запомнить меня</label>
                        </div>
                        <a href="forgot-password.html" class="forgot-link">Забыли пароль?</a>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-3" id="submitBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        Войти в систему
                    </button>
                    
                    <div class="auth-divider">
                        <span>или войдите с помощью</span>
                    </div>
                    
                    <div class="grid grid-2 gap-2">
                        <button type="button" class="btn btn-outline" onclick="loginWithGoogle()">
                            <i class="fab fa-google"></i>
                            Google
                        </button>
                        <button type="button" class="btn btn-outline" onclick="loginWithGitHub()">
                            <i class="fab fa-github"></i>
                            GitHub
                        </button>
                    </div>
                </form>
                
                <div class="auth-footer text-center">
                    Нет аккаунта? <a href="registration.html">Зарегистрируйтесь здесь</a>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-auto">
        <div class="container text-center">
            <p class="copyright text-muted">© 2025 Метро New. Все права защищены.</p>
        </div>
    </footer>

    <script>
        // Firebase конфигурация
        const firebaseConfig = {
            apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
            authDomain: "metro-new-85226.firebaseapp.com",
            projectId: "metro-new-85226",
            storageBucket: "metro-new-85226.firebasestorage.app",
            messagingSenderId: "905640751733",
            appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
        };

        // Инициализация Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase инициализирован для входа');
        } catch (error) {
            console.log('Firebase уже инициализирован');
            auth = firebase.auth();
            db = firebase.firestore();
        }

        // Проверяем, если пользователь уже авторизован - редирект на профиль
        const currentUser = JSON.parse(localStorage.getItem('metro_user'));
        if (currentUser) {
            window.location.href = 'profile.html';
        }

        // Функции уведомлений
        function showNotification(message, type = 'info') {
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(notif => notif.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            
            if (errorElement && inputElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                inputElement.classList.add('error');
            }
        }

        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            const inputElements = document.querySelectorAll('.form-input');
            
            errorElements.forEach(el => el.style.display = 'none');
            inputElements.forEach(el => el.classList.remove('error'));
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentNode.querySelector('.password-toggle i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function setLoading(loading) {
            const submitBtn = document.getElementById('submitBtn');
            if (loading) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Вход...';
                submitBtn.disabled = true;
            } else {
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Войти в систему';
                submitBtn.disabled = false;
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Обработчик формы входа
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            setLoading(true);
            clearErrors();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Валидация
            let isValid = true;

            if (!email) {
                showError('email', 'Введите email адрес');
                isValid = false;
            } else if (!isValidEmail(email)) {
                showError('email', 'Введите корректный email адрес');
                isValid = false;
            }

            if (!password) {
                showError('password', 'Введите пароль');
                isValid = false;
            }

            if (!isValid) {
                setLoading(false);
                return;
            }

            try {
                console.log('Попытка входа...');
                
                // Вход через Firebase
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('Вход успешен:', user.uid);

                // Получаем данные пользователя из Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                let userData;
                if (userDoc.exists) {
                    // Обновляем существующие данные
                    userData = userDoc.data();
                    userData.lastLogin = new Date().toISOString();
                    userData.rememberMe = rememberMe;
                    
                    // Добавляем в историю входов
                    if (!userData.loginHistory) {
                        userData.loginHistory = [];
                    }
                    userData.loginHistory.unshift({
                        time: new Date().toISOString(),
                        ip: await getUserIP(),
                        userAgent: navigator.userAgent
                    });
                    
                    // Ограничиваем историю последними 10 входами
                    userData.loginHistory = userData.loginHistory.slice(0, 10);
                    
                    // Обновляем в Firestore
                    await db.collection('users').doc(user.uid).update(userData);
                } else {
                    // Создаем базовый профиль если не найден
                    const username = email.split('@')[0];
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || username,
                        username: username,
                        photoURL: user.photoURL || '',
                        emailVerified: user.emailVerified,
                        lastLogin: new Date().toISOString(),
                        rememberMe: rememberMe,
                        settings: {
                            theme: 'light',
                            notifications: true,
                            language: 'ru'
                        },
                        stats: {
                            gamesPlayed: 0,
                            totalScore: 0,
                            level: 1,
                            experience: 0
                        },
                        loginHistory: [{
                            time: new Date().toISOString(),
                            ip: await getUserIP(),
                            userAgent: navigator.userAgent
                        }]
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                }

                // Сохраняем в localStorage
                localStorage.setItem('metro_user', JSON.stringify(userData));

                showNotification('✅ Вход выполнен успешно!', 'success');

                // Автоматический переход на профиль через 1.5 секунды
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1500);

            } catch (error) {
                console.error('Ошибка входа:', error);
                
                let errorMessage = 'Ошибка входа. Попробуйте снова.';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '❌ Пользователь с таким email не найден';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = '❌ Неверный пароль';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '❌ Неверный формат email адреса';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = '❌ Слишком много попыток. Попробуйте позже.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = '❌ Ошибка сети. Проверьте подключение к интернету';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = '❌ Аккаунт заблокирован';
                }
                
                showNotification(errorMessage, 'error');
                setLoading(false);
            }
        });

        // OAuth вход
        async function loginWithGoogle() {
            try {
                setLoading(true);
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');

                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                // Получаем или создаем профиль
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                let userData;
                if (userDoc.exists) {
                    userData = userDoc.data();
                    userData.lastLogin = new Date().toISOString();
                    
                    // Обновляем в Firestore
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString()
                    });
                } else {
                    // Создаем новый профиль
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        username: user.email.split('@')[0],
                        photoURL: user.photoURL,
                        emailVerified: user.emailVerified,
                        provider: 'google',
                        registrationDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        settings: {
                            theme: 'light',
                            notifications: true,
                            language: 'ru'
                        },
                        stats: {
                            gamesPlayed: 0,
                            totalScore: 0,
                            level: 1,
                            experience: 0
                        },
                        loginHistory: [{
                            time: new Date().toISOString(),
                            ip: await getUserIP(),
                            userAgent: navigator.userAgent
                        }]
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                }

                localStorage.setItem('metro_user', JSON.stringify(userData));
                showNotification('✅ Вход через Google выполнен!', 'success');

                // Переход на профиль
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1500);

            } catch (error) {
                console.error('Ошибка входа через Google:', error);
                showNotification('❌ Ошибка входа через Google', 'error');
                setLoading(false);
            }
        }

        async function loginWithGitHub() {
            try {
                setLoading(true);
                
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('user:email');

                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                // Получаем или создаем профиль
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                let userData;
                if (userDoc.exists) {
                    userData = userDoc.data();
                    userData.lastLogin = new Date().toISOString();
                    
                    // Обновляем в Firestore
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString()
                    });
                } else {
                    // Создаем новый профиль
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        username: user.email.split('@')[0],
                        photoURL: user.photoURL,
                        emailVerified: user.emailVerified,
                        provider: 'github',
                        registrationDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        settings: {
                            theme: 'light',
                            notifications: true,
                            language: 'ru'
                        },
                        stats: {
                            gamesPlayed: 0,
                            totalScore: 0,
                            level: 1,
                            experience: 0
                        },
                        loginHistory: [{
                            time: new Date().toISOString(),
                            ip: await getUserIP(),
                            userAgent: navigator.userAgent
                        }]
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                }

                localStorage.setItem('metro_user', JSON.stringify(userData));
                showNotification('✅ Вход через GitHub выполнен!', 'success');

                // Переход на профиль
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1500);

            } catch (error) {
                console.error('Ошибка входа через GitHub:', error);
                showNotification('❌ Ошибка входа через GitHub', 'error');
                setLoading(false);
            }
        }

        // Получение IP пользователя
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        // Демо аккаунты для тестирования
        function fillDemoAccount(type) {
            let email, password;
            
            if (type === 'user') {
                email = 'demo@metro.new';
                password = '123456';
            } else if (type === 'admin') {
                email = 'admin@metro.new';
                password = 'admin123';
            }
            
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
            document.getElementById('rememberMe').checked = true;
            
            showNotification(`Демо аккаунт "${email}" загружен!`, 'success');
        }

        // Добавляем кнопки для тестирования
        document.addEventListener('DOMContentLoaded', function() {
            // Кнопка демо пользователя
            const demoUserBtn = document.createElement('button');
            demoUserBtn.textContent = 'DEMO USER';
            demoUserBtn.style.position = 'fixed';
            demoUserBtn.style.top = '10px';
            demoUserBtn.style.left = '10px';
            demoUserBtn.style.zIndex = '10000';
            demoUserBtn.style.padding = '8px 12px';
            demoUserBtn.style.background = '#ff4444';
            demoUserBtn.style.color = 'white';
            demoUserBtn.style.border = 'none';
            demoUserBtn.style.borderRadius = '5px';
            demoUserBtn.style.cursor = 'pointer';
            demoUserBtn.style.fontSize = '12px';
            demoUserBtn.style.fontWeight = 'bold';
            demoUserBtn.onclick = () => fillDemoAccount('user');
            document.body.appendChild(demoUserBtn);

            // Кнопка демо админа
            const demoAdminBtn = document.createElement('button');
            demoAdminBtn.textContent = 'DEMO ADMIN';
            demoAdminBtn.style.position = 'fixed';
            demoAdminBtn.style.top = '50px';
            demoAdminBtn.style.left = '10px';
            demoAdminBtn.style.zIndex = '10000';
            demoAdminBtn.style.padding = '8px 12px';
            demoAdminBtn.style.background = '#4444ff';
            demoAdminBtn.style.color = 'white';
            demoAdminBtn.style.border = 'none';
            demoAdminBtn.style.borderRadius = '5px';
            demoAdminBtn.style.cursor = 'pointer';
            demoAdminBtn.style.fontSize = '12px';
            demoAdminBtn.style.fontWeight = 'bold';
            demoAdminBtn.onclick = () => fillDemoAccount('admin');
            document.body.appendChild(demoAdminBtn);

            console.log('Страница входа загружена');
        });

        // Быстрый вход по Enter
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginForm').dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>
