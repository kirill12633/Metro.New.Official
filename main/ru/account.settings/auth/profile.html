<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль - Метро New</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <nav class="nav">
        <div class="container nav-container">
            <div class="logo">
                <span class="logo-icon">M</span>
                <span>Метро New</span>
            </div>
            <div class="nav-links">
                <a href="../../../index.html">Главная</a>
                <a href="../../../game.html">Игра</a>
                <a href="settings.html">Настройки</a>
                <a href="#" id="logoutBtn">Выйти</a>
                <div class="user-info d-flex align-center gap-2">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span class="user-name" id="userName">Пользователь</span>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <div class="container" style="padding: 2rem 0;">
            <div class="metro-background"></div>
            
            <div class="profile-header animate-fade-in-up">
                <div class="card text-center">
                    <div id="profileAvatar" class="profile-avatar">U</div>
                    <h1 id="profileName">Пользователь</h1>
                    <p class="text-muted" id="profileEmail">user@example.com</p>
                    
                    <!-- Статус верификации email -->
                    <div id="verificationStatus" class="mb-3">
                        <span id="verifiedBadge" class="badge badge-success" style="display: none;">
                            <i class="fas fa-check-circle"></i> Email подтверждён
                        </span>
                        <span id="notVerifiedBadge" class="badge badge-warning">
                            <i class="fas fa-exclamation-triangle"></i> Email не подтверждён
                        </span>
                        <button id="verifyEmailBtn" class="btn btn-sm btn-outline ml-2" onclick="sendEmailVerification()">
                            Подтвердить email
                        </button>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="gamesPlayed">0</div>
                            <div class="stat-label">Игр сыграно</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalScore">0</div>
                            <div class="stat-label">Общий счет</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="userLevel">1</div>
                            <div class="stat-label">Уровень</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2 gap-3">
                <!-- Редактирование профиля -->
                <div class="card">
                    <h3><i class="fas fa-user-edit"></i> Редактировать профиль</h3>
                    <div class="form-group">
                        <label class="form-label">Имя пользователя</label>
                        <input type="text" class="form-input" id="displayName" placeholder="Введите имя">
                    </div>
                    <button class="btn btn-primary" onclick="updateProfile()">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>

                <!-- Безопасность -->
                <div class="card">
                    <h3><i class="fas fa-shield-alt"></i> Безопасность</h3>
                    <div class="settings-option">
                        <div class="option-info">
                            <h4>Сменить пароль</h4>
                            <p>Обновите ваш пароль для безопасности</p>
                        </div>
                        <button class="btn btn-outline" onclick="changePassword()">
                            <i class="fas fa-key"></i> Сменить
                        </button>
                    </div>
                    
                    <div class="settings-option">
                        <div class="option-info">
                            <h4>Сменить email</h4>
                            <p>Изменить адрес электронной почты</p>
                        </div>
                        <button class="btn btn-outline" onclick="changeEmail()">
                            <i class="fas fa-envelope"></i> Сменить
                        </button>
                    </div>
                    
                    <div class="settings-option">
                        <div class="option-info">
                            <h4>Выйти из системы</h4>
                            <p>Завершить текущую сессию</p>
                        </div>
                        <button class="btn btn-outline" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Выйти
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebase конфиг - ЗАМЕНИ НА СВОЙ!
const firebaseConfig = {
  apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
  authDomain: "metro-new-85226.firebaseapp.com",
  projectId: "metro-new-85226",
  storageBucket: "metro-new-85226.firebasestorage.app",
  messagingSenderId: "905640751733",
  appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
};
        // Инициализация Firebase
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            console.log('Firebase инициализирован');
        } catch (error) {
            console.log('Firebase уже инициализирован');
            auth = firebase.auth();
        }

        // Проверяем авторизацию
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadUserProfile(user);
            } else {
                window.location.href = 'login.html';
            }
        });

        // Загрузка профиля
        function loadUserProfile(user) {
            document.getElementById('profileName').textContent = user.displayName || user.email;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('userAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
            document.getElementById('profileAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
            document.getElementById('displayName').value = user.displayName || '';

            // Проверка верификации email
            if (user.emailVerified) {
                document.getElementById('verifiedBadge').style.display = 'inline-flex';
                document.getElementById('notVerifiedBadge').style.display = 'none';
                document.getElementById('verifyEmailBtn').style.display = 'none';
            } else {
                document.getElementById('verifiedBadge').style.display = 'none';
                document.getElementById('notVerifiedBadge').style.display = 'inline-flex';
                document.getElementById('verifyEmailBtn').style.display = 'inline-flex';
            }

            // Загружаем данные из localStorage
            const userData = JSON.parse(localStorage.getItem('metro_user'));
            if (userData && userData.stats) {
                document.getElementById('gamesPlayed').textContent = userData.stats.gamesPlayed || 0;
                document.getElementById('totalScore').textContent = userData.stats.totalScore || 0;
                document.getElementById('userLevel').textContent = userData.stats.level || 1;
            }
        }

        // Обновление профиля
        async function updateProfile() {
            const displayName = document.getElementById('displayName').value;
            if (displayName) {
                try {
                    const user = auth.currentUser;
                    await user.updateProfile({
                        displayName: displayName
                    });

                    // Обновляем UI
                    document.getElementById('profileName').textContent = displayName;
                    document.getElementById('userName').textContent = displayName;
                    document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
                    document.getElementById('profileAvatar').textContent = displayName.charAt(0).toUpperCase();

                    showNotification('✅ Профиль обновлен!', 'success');
                } catch (error) {
                    console.error('Ошибка обновления:', error);
                    showNotification('❌ Ошибка обновления профиля', 'error');
                }
            }
        }

        // Отправка подтверждения email
        async function sendEmailVerification() {
            try {
                const user = auth.currentUser;
                await user.sendEmailVerification();
                showNotification('✅ Письмо с подтверждением отправлено!', 'success');
            } catch (error) {
                console.error('Ошибка отправки:', error);
                showNotification('❌ Ошибка отправки подтверждения', 'error');
            }
        }

        // Смена пароля
        async function changePassword() {
            const newPassword = prompt('Введите новый пароль (минимум 6 символов):');
            if (newPassword && newPassword.length >= 6) {
                try {
                    const user = auth.currentUser;
                    await user.updatePassword(newPassword);
                    showNotification('✅ Пароль успешно изменен!', 'success');
                } catch (error) {
                    console.error('Ошибка смены пароля:', error);
                    showNotification('❌ Ошибка смены пароля', 'error');
                }
            } else if (newPassword) {
                showNotification('❌ Пароль должен быть минимум 6 символов', 'error');
            }
        }

        // Смена email
        async function changeEmail() {
            const newEmail = prompt('Введите новый email:');
            if (newEmail) {
                try {
                    const user = auth.currentUser;
                    await user.updateEmail(newEmail);
                    showNotification('✅ Email успешно изменен!', 'success');
                    // Перезагружаем страницу чтобы обновить данные
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    console.error('Ошибка смены email:', error);
                    showNotification('❌ Ошибка смены email', 'error');
                }
            }
        }

        // Выход
        async function logout() {
            try {
                await auth.signOut();
                localStorage.removeItem('metro_user');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Ошибка выхода:', error);
            }
        }

        // Уведомления
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check' : 'info'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Обработчик кнопки выхода в навигации
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });
    </script>
</body>
</html>
