<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1–†–µ–¥–∞–∫—Ç–æ—Ä –í–∏–∫–∏</title>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: #2c3e50; color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo h1 { font-size: 24px; font-weight: 600; }
        .logo-icon { font-size: 28px; }
        .nav-buttons { display: flex; gap: 10px; }
        .nav-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px; transition: all 0.3s; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .main-content { padding: 30px; display: grid; grid-template-columns: 1fr 300px; gap: 30px; }
        .editor-section, .sidebar { background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e9ecef; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; }
        input[type="text"], textarea { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; font-family: inherit; transition: all 0.3s; background: white; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        textarea { min-height: 300px; resize: vertical; line-height: 1.6; }
        .char-count { text-align: right; font-size: 12px; color: #6c757d; margin-top: 5px; }
        .button-group { display: flex; gap: 12px; margin-top: 25px; }
        button { padding: 12px 25px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; transform: translateY(-1px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-preview { background: #2196F3; color: white; }
        .btn-preview:hover { background: #0b7dda; }
        .message { padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }
        .message-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .preview-section { background: white; padding: 25px; border-radius: 10px; border: 2px solid #e9ecef; margin-top: 20px; display: none; }
        .preview-title { color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        .recent-articles { margin-top: 25px; }
        .article-list { max-height: 200px; overflow-y: auto; }
        .article-item { padding: 10px; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background 0.3s; }
        .article-item:hover { background: #e9ecef; }
        .article-item:last-child { border-bottom: none; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; }
        .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 12px; color: #6c757d; margin-top: 5px; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } header { flex-direction: column; gap: 15px; text-align: center; } .button-group { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üìù</div>
                <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –í–∏–∫–∏</h1>
            </div>
            <div class="nav-buttons">
                <a href="#" class="nav-btn" onclick="showAllArticles()">üìö –í—Å–µ —Å—Ç–∞—Ç—å–∏</a>
                <a href="#" class="nav-btn" onclick="clearForm()">üÜï –ù–æ–≤–∞—è</a>
            </div>
        </header>
        
        <div class="main-content">
            <div class="editor-section">
                <form id="edit-form">
                    <div class="form-group">
                        <label for="pageName">üìÑ –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
                        <input type="text" id="pageName" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏">
                    </div>
                    
                    <div class="form-group">
                        <label for="content">üìù –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏</label>
                        <textarea id="content" required placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏ –∑–¥–µ—Å—å..."></textarea>
                        <div class="char-count">
                            <span id="char-count">0</span> —Å–∏–º–≤–æ–ª–æ–≤
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editedBy">üë§ –í–∞—à–µ –∏–º—è</label>
                        <input type="text" id="editedBy" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn-primary">
                            <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é</span>
                        </button>
                        <button type="button" class="btn-preview" onclick="togglePreview()">
                            <span>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </button>
                        <button type="button" class="btn-secondary" onclick="clearForm()">
                            <span>üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</span>
                        </button>
                    </div>
                </form>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</p>
                </div>
                
                <div id="message" class="message"></div>
                
                <div id="preview-section" class="preview-section">
                    <h3 class="preview-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏</h3>
                    <div id="preview-content"></div>
                </div>
            </div>
            
            <div class="sidebar">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number" id="total-pages">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç–∞—Ç–µ–π</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="today-pages">0</div>
                        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                </div>
                
                <div class="recent-articles">
                    <h3>üìñ –ù–µ–¥–∞–≤–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h3>
                    <div class="article-list" id="recent-articles">
                        <div class="article-item">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
                    <h4>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏</h4>
                    <ul style="font-size: 12px; color: #666; margin-top: 10px; padding-left: 20px;">
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTML –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                        <li>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ</li>
                        <li>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, serverTimestamp, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
            authDomain: "metro-new-85226.firebaseapp.com",
            projectId: "metro-new-85226",
            storageBucket: "metro-new-85226.firebasestorage.app",
            messagingSenderId: "905640751733",
            appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è App Check
        let appCheck;
        try {
            appCheck = initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('6Ld9uw0sAAAAAMTSxQ9Vxd0LhEcwweHGF-DWdZIo'), // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∫–ª—é—á
                isTokenAutoRefreshEnabled: true
            });
            console.log('App Check –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
            console.warn('App Check –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', error);
        }

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const form = document.getElementById('edit-form');
        const pageNameInput = document.getElementById('pageName');
        const contentInput = document.getElementById('content');
        const editedByInput = document.getElementById('editedBy');
        const messageDiv = document.getElementById('message');
        const previewSection = document.getElementById('preview-section');
        const previewContent = document.getElementById('preview-content');
        const charCount = document.getElementById('char-count');
        const loadingDiv = document.getElementById('loading');
        const totalPagesElement = document.getElementById('total-pages');
        const todayPagesElement = document.getElementById('today-pages');
        const recentArticlesElement = document.getElementById('recent-articles');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentPageId = null;
        const urlParams = new URLSearchParams(window.location.search);
        const editPageId = urlParams.get('edit');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
        function generatePageId(pageName) {
            return pageName
                .toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9–∞-—è—ë-]/g, '')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
        function updateCharCount() {
            charCount.textContent = contentInput.value.length;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        function togglePreview() {
            if (previewSection.style.display === 'block') {
                previewSection.style.display = 'none';
            } else {
                const title = pageNameInput.value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                const content = contentInput.value || '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                
                previewContent.innerHTML = `
                    <h2>${title}</h2>
                    <div style="margin-top: 20px; line-height: 1.6;">
                        ${content}
                    </div>
                `;
                previewSection.style.display = 'block';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message message-${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, type === 'success' ? 3000 : 5000);
        }

        // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
        function clearForm() {
            pageNameInput.value = '';
            contentInput.value = '';
            editedByInput.value = '';
            currentPageId = null;
            previewSection.style.display = 'none';
            updateCharCount();
            showMessage('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å—Ç–∞—Ç—å–∏
        async function loadStatsAndArticles() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–µ–π...');
                const querySnapshot = await getDocs(query(collection(db, "pages"), orderBy("timestamp", "desc")));
                const articles = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let todayCount = 0;

                querySnapshot.forEach((doc) => {
                    const article = doc.data();
                    articles.push({
                        id: doc.id,
                        ...article
                    });

                    // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç—å–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                    if (article.timestamp?.toDate) {
                        const articleDate = article.timestamp.toDate();
                        articleDate.setHours(0, 0, 0, 0);
                        if (articleDate.getTime() === today.getTime()) {
                            todayCount++;
                        }
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                totalPagesElement.textContent = articles.length;
                todayPagesElement.textContent = todayCount;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π
                recentArticlesElement.innerHTML = '';
                if (articles.length === 0) {
                    recentArticlesElement.innerHTML = '<div class="article-item">–°—Ç–∞—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                } else {
                    articles.slice(0, 5).forEach(article => {
                        const articleItem = document.createElement('div');
                        articleItem.className = 'article-item';
                        articleItem.innerHTML = `
                            <strong>${article.pageName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
                            <div style="font-size: 12px; color: #666;">
                                ${article.createdBy || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ‚Ä¢ 
                                ${article.timestamp?.toDate ? new Date(article.timestamp.toDate()).toLocaleDateString('ru-RU') : '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}
                            </div>
                        `;
                        articleItem.onclick = () => loadArticleForEdit(article.id);
                        recentArticlesElement.appendChild(articleItem);
                    });
                }

                console.log('–°—Ç–∞—Ç—å–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', articles.length);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showMessage(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadArticleForEdit(pageId) {
            try {
                const docRef = doc(db, "pages", pageId);
                const docSnap = await getDocs(collection(db, "pages"));
                
                let foundArticle = null;
                docSnap.forEach((doc) => {
                    if (doc.id === pageId) {
                        foundArticle = doc.data();
                    }
                });

                if (foundArticle) {
                    pageNameInput.value = foundArticle.pageName || '';
                    contentInput.value = foundArticle.content || '';
                    editedByInput.value = foundArticle.editedBy || foundArticle.createdBy || '';
                    currentPageId = pageId;
                    updateCharCount();
                    showMessage(`–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç–∞—Ç—å—è: ${foundArticle.pageName}`, 'success');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—å–∏
        function showAllArticles() {
            alert('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ç–µ–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        async function handleSubmit(e) {
            e.preventDefault();
            
            const pageName = pageNameInput.value.trim();
            const content = contentInput.value.trim();
            const editedBy = editedByInput.value.trim();
            
            if (!pageName || !content || !editedBy) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loadingDiv.style.display = 'block';
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            try {
                const pageId = currentPageId || generatePageId(pageName);
                
                const pageData = {
                    pageName: pageName,
                    content: content,
                    editedBy: editedBy,
                    timestamp: serverTimestamp()
                };

                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è —Å—Ç–∞—Ç—å—è, –¥–æ–±–∞–≤–ª—è–µ–º createdBy
                if (!currentPageId) {
                    pageData.createdBy = editedBy;
                }

                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏:', pageId, pageData);
                await setDoc(doc(db, "pages", pageId), pageData, { merge: true });
                
                showMessage(`‚úÖ –°—Ç–∞—Ç—å—è "${pageName}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`, 'success');
                currentPageId = pageId;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                setTimeout(loadStatsAndArticles, 1000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            } finally {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadStatsAndArticles();
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω ID –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (editPageId) {
                loadArticleForEdit(editPageId);
            }

            // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
            form.addEventListener('submit', handleSubmit);
            contentInput.addEventListener('input', updateCharCount);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫
            updateCharCount();

            console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        });
    </script>
</body>
</html>
