<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ú–µ—Ç—Ä–æ New</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <!-- reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <style>
        :root {
            --primary: #0066CC;
            --primary-dark: #0052a3;
            --primary-light: #4d94ff;
            --secondary: #FFD700;
            --secondary-dark: #e6c200;
            --dark: #1A1A1A;
            --light: #F8F9FA;
            --gray: #6C757D;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --info: #17A2B8;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.2);
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 15px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* üîê –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2.5rem;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 2rem;
        }
        
        .metro-icon {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        
        .login-header h1 {
            font-size: 1.8rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .login-header p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 2px solid #e1e5e9;
            border-radius: var(--radius-md);
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: #f8f9fa;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .password-container {
            position: relative;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
        }
        
        .recaptcha-container {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.9rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            width: 100%;
            font-size: 1rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--gray);
        }
        
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
        }
        
        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
        }
        
        .alert-info {
            background: rgba(23, 162, 184, 0.1);
            border: 2px solid var(--info);
            color: var(--info);
        }
        
        .login-footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e1e5e9;
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* üìä –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .admin-panel {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }
        
        .header {
            background: white;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            font-weight: bold;
        }
        
        .btn-logout {
            padding: 0.5rem 1rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tickets-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }
        
        .ticket-item {
            border: 1px solid #e1e5e9;
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
            position: relative;
        }
        
        .ticket-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .ticket-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: var(--radius-md);
        }
        
        .ticket-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-new { background: #e3f2fd; color: #1976d2; border: 1px solid #1976d2; }
        .status-progress { background: #fff3e0; color: #f57c00; border: 1px solid #f57c00; }
        .status-resolved { background: #e8f5e9; color: #388e3c; border: 1px solid #388e3c; }
        .status-archived { background: #f5f5f5; color: #616161; border: 1px solid #616161; }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .filters {
            display: flex;
            gap: 0.5rem;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-xl);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        @media (max-width: 768px) {
            .login-card {
                padding: 1.5rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .ticket-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .ticket-actions {
                width: 100%;
            }
            
            .ticket-actions .btn-action {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- üîê –°–¢–†–ê–ù–ò–¶–ê –í–•–û–î–ê -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="metro-icon">üöá</div>
                <h1>–¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ú–µ—Ç—Ä–æ New</h1>
                <p>–¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</p>
            </div>
            
            <div id="loginAlert" class="alert" style="display: none;"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                    <input type="email" id="loginEmail" class="form-control" 
                           placeholder="admin@metro-new.ru" required
                           pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" class="form-control" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                        <button type="button" class="toggle-password" onclick="togglePassword()">
                            <i class="far fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="recaptcha-container">
                    <div class="g-recaptcha" data-sitekey="6Lfr5g0sAAAAANmMqIPHhQ6pvNa3YnVcXs3A4eR2"></div>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                </button>
            </form>
            
            <div class="login-footer">
                <p><i class="fas fa-shield-alt"></i> –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º–∏ —É—á–µ—Ç–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏</p>
                <p style="font-size: 0.7rem; margin-top: 0.5rem;">–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≥–ª–∞–≤–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</p>
            </div>
        </div>
    </div>
    
    <!-- üìä –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
    <div id="adminPage" style="display: none;">
        <header class="header">
            <div class="container">
                <nav>
                    <div class="logo">
                        <span class="logo-icon">M</span>
                        <span>–ú–µ—Ç—Ä–æ New | –¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                    </div>
                    
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div>
                            <div id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                            <div id="userRole" style="font-size: 0.8rem; color: var(--gray);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                        <button class="btn-logout" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                        </button>
                    </div>
                </nav>
            </div>
        </header>
        
        <main class="container" style="padding: 2rem 0;">
            <!-- üìà –î–ê–®–ë–û–†–î -->
            <div class="dashboard-grid" id="dashboard">
                <div class="stat-card">
                    <span class="stat-number" id="statTotal">0</span>
                    <span class="stat-label">–í—Å–µ–≥–æ —Ç–∏–∫–µ—Ç–æ–≤</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="statNew">0</span>
                    <span class="stat-label">–ù–æ–≤—ã–µ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="statProgress">0</span>
                    <span class="stat-label">–í —Ä–∞–±–æ—Ç–µ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="statResolved">0</span>
                    <span class="stat-label">–†–µ—à–µ–Ω—ã</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="statResponseTime">0–º</span>
                    <span class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</span>
                </div>
            </div>
            
            <!-- üéõÔ∏è –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
            <div class="admin-panel">
                <div class="controls">
                    <div class="search-box">
                        <input type="text" class="form-control" id="searchTickets" 
                               placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID, email –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—é...">
                    </div>
                    
                    <div class="filters">
                        <select class="form-control" id="statusFilter" style="width: 150px;">
                            <option value="all">üìã –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="new">üÜï –ù–æ–≤—ã–µ</option>
                            <option value="in-progress">üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="resolved">‚úÖ –†–µ—à–µ–Ω—ã</option>
                            <option value="archived">üóÑÔ∏è –ê—Ä—Ö–∏–≤</option>
                        </select>
                        
                        <select class="form-control" id="priorityFilter" style="width: 150px;">
                            <option value="all">üö¶ –í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                            <option value="critical">üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                            <option value="high">‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π</option>
                            <option value="medium">üìù –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="low">‚úÖ –ù–∏–∑–∫–∏–π</option>
                        </select>
                        
                        <button class="btn-action btn-info" onclick="exportBackup()">
                            <i class="fas fa-download"></i> –ë–µ–∫–∞–ø
                        </button>
                        
                        <button class="btn-action btn-secondary" onclick="showArchived()">
                            <i class="fas fa-archive"></i> –ê—Ä—Ö–∏–≤
                        </button>
                    </div>
                </div>
                
                <!-- üìã –°–ü–ò–°–û–ö –¢–ò–ö–ï–¢–û–í -->
                <div id="ticketsList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- üìù –ú–û–î–ê–õ–ö–ê –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
        // üî• –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
            authDomain: "metro-new-85226.firebaseapp.com",
            projectId: "metro-new-85226",
            storageBucket: "metro-new-85226.firebasestorage.app",
            messagingSenderId: "905640751733",
            appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
        };

        // üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            // –í–∫–ª—é—á–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º
            db.enablePersistence().catch(err => {
                console.log('–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º:', err.message);
            });
            
            console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
            showLoginAlert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase', 'danger');
        }

        // üõ°Ô∏è –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
        const SECURITY_CONFIG = {
            maxLoginAttempts: 5,
            lockoutTime: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
            sessionTimeout: 60 * 60 * 1000, // 1 —á–∞—Å
            allowedDomains: ['metro-new.ru', 'metro.new.help@gmail.com']
        };

        let loginAttempts = 0;
        let lastFailedAttempt = 0;
        let sessionTimer = null;
        let currentUser = null;

        // üëÅÔ∏è‚Äçüó®Ô∏è –§–£–ù–ö–¶–ò–ò –í–•–û–î–ê/–í–´–•–û–î–ê
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const recaptchaResponse = grecaptcha.getResponse();
            
            if (!recaptchaResponse) {
                showLoginAlert('–ü—Ä–æ–π–¥–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É reCAPTCHA', 'danger');
                return;
            }
            
            // üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            if (isAccountLocked()) {
                showLoginAlert('–ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'danger');
                return;
            }
            
            // üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞
            if (!isAllowedDomain(email)) {
                showLoginAlert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π email.', 'danger');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –í—Ö–æ–¥...';
            loginBtn.disabled = true;
            
            try {
                // üîê –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Firebase Authentication
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ admins
                const adminDoc = await db.collection('admins').doc(currentUser.uid).get();
                
                if (!adminDoc.exists) {
                    await auth.signOut();
                    throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
                }
                
                const adminData = adminDoc.data();
                
                // üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
                if (!adminData.roles || !adminData.roles.includes('admin')) {
                    await auth.signOut();
                    throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.');
                }
                
                // ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                loginAttempts = 0;
                startSessionTimer();
                showAdminPanel(adminData);
                
                // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥
                await db.collection('audit_log').add({
                    action: 'login',
                    userId: currentUser.uid,
                    email: currentUser.email,
                    timestamp: new Date().toISOString(),
                    ip: await getClientIP(),
                    userAgent: navigator.userAgent
                });
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                
                // üõ°Ô∏è –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
                loginAttempts++;
                lastFailedAttempt = Date.now();
                
                // –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. ';
                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.';
                        break;
                    default:
                        errorMessage += error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
                }
                
                showLoginAlert(errorMessage, 'danger');
                
                // –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É
                db.collection('failed_logins').add({
                    email: email,
                    timestamp: new Date().toISOString(),
                    ip: await getClientIP(),
                    userAgent: navigator.userAgent
                });
                
            } finally {
                grecaptcha.reset();
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
                loginBtn.disabled = false;
            }
        }

        // üö™ –í–´–•–û–î –ò–ó –°–ò–°–¢–ï–ú–´
        async function logout() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) return;
            
            try {
                // –õ–æ–≥–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥
                await db.collection('audit_log').add({
                    action: 'logout',
                    userId: currentUser.uid,
                    email: currentUser.email,
                    timestamp: new Date().toISOString()
                });
                
                await auth.signOut();
                currentUser = null;
                
                // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
                clearTimeout(sessionTimer);
                localStorage.removeItem('admin_session');
                sessionStorage.clear();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                document.getElementById('adminPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                
                showLoginAlert('–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            }
        }

        // üìä –ó–ê–ì–†–£–ó–ö–ê –¢–ò–ö–ï–¢–û–í –° –ò–ù–î–ï–ö–°–ê–ú–ò
        async function loadTickets() {
            const ticketsList = document.getElementById('ticketsList');
            ticketsList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤...</p></div>';
            
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const searchQuery = document.getElementById('searchTickets').value.toLowerCase();
            
            try {
                let query = db.collection('tickets');
                
                // üéØ –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
                if (statusFilter !== 'all') {
                    query = query.where('status', '==', statusFilter);
                }
                
                if (priorityFilter !== 'all') {
                    query = query.where('priority', '==', priorityFilter);
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–∏–Ω–¥–µ–∫—Å required)
                query = query.orderBy('createdAt', 'desc');
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    ticketsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>–¢–∏–∫–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                            <p>–ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                        </div>
                    `;
                    return;
                }
                
                let ticketsHTML = '';
                
                snapshot.forEach((doc) => {
                    const ticket = doc.data();
                    const ticketId = doc.id;
                    
                    // üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É (–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞)
                    if (searchQuery && !ticketMatchesSearch(ticket, searchQuery)) {
                        return;
                    }
                    
                    ticketsHTML += renderTicket(ticketId, ticket);
                });
                
                ticketsList.innerHTML = ticketsHTML || `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                    </div>
                `;
                
                loadStats();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤:', error);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
                if (error.code === 'failed-precondition') {
                    console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –∑–∞–≥—Ä—É–∑–∫—É');
                    loadTicketsFallback();
                    return;
                }
                
                ticketsList.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <p>${error.message}</p>
                        <button class="btn-action" onclick="loadTickets()">
                            <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        }

        // üõ†Ô∏è –†–ï–ù–î–ï–†–ò–ù–ì –¢–ò–ö–ï–¢–ê
        function renderTicket(ticketId, ticket) {
            return `
                <div class="ticket-item" data-id="${ticketId}" data-status="${ticket.status}">
                    <div class="ticket-header">
                        <div>
                            <h3 style="margin: 0;">üé´ ${ticketId}</h3>
                            <div style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                                <span class="status-badge status-${ticket.status}">
                                    ${getStatusText(ticket.status)}
                                </span>
                                ${ticket.priority ? `
                                    <span class="status-badge" style="background: ${getPriorityColor(ticket.priority)}; margin-left: 0.5rem;">
                                        ${getPriorityText(ticket.priority)}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            üë§ ${ticket.name} ‚Ä¢ ${getPositionText(ticket.position)}
                        </div>
                    </div>
                    
                    <div class="ticket-meta">
                        <div><strong>üìß Email:</strong><br>${ticket.email}</div>
                        <div><strong>üìÖ –î–∞—Ç–∞:</strong><br>${new Date(ticket.createdAt).toLocaleString('ru-RU')}</div>
                        <div><strong>‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong><br>${calculateResponseTime(ticket) || '–ù–µ –Ω–∞—á–∞—Ç–æ'}</div>
                        ${ticket.assignedTo ? `<div><strong>üë®‚Äçüíº –ù–∞–∑–Ω–∞—á–µ–Ω–æ:</strong><br>${ticket.assignedTo}</div>` : ''}
                    </div>
                    
                    <div>
                        <strong>üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:</strong>
                        <p style="margin: 0.5rem 0; padding: 1rem; background: #f8f9fa; border-radius: var(--radius-md);">
                            ${ticket.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </p>
                    </div>
                    
                    <div class="ticket-actions">
                        ${ticket.status === 'new' ? `
                            <button class="btn-action btn-warning" onclick="updateTicket('${ticketId}', 'in-progress')">
                                <i class="fas fa-play-circle"></i> –í —Ä–∞–±–æ—Ç—É
                            </button>
                        ` : ''}
                        
                        ${ticket.status === 'in-progress' ? `
                            <button class="btn-action btn-success" onclick="updateTicket('${ticketId}', 'resolved')">
                                <i class="fas fa-check-circle"></i> –†–µ—à–µ–Ω–æ
                            </button>
                        ` : ''}
                        
                        ${ticket.status !== 'archived' ? `
                            <button class="btn-action btn-danger" onclick="moveToArchive('${ticketId}')">
                                <i class="fas fa-archive"></i> –í –∞—Ä—Ö–∏–≤
                            </button>
                        ` : ''}
                        
                        <button class="btn-action btn-info" onclick="openEditModal('${ticketId}')">
                            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        
                        ${ticket.status === 'archived' ? `
                            <button class="btn-action btn-secondary" onclick="restoreFromArchive('${ticketId}')">
                                <i class="fas fa-trash-restore"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // üóÑÔ∏è –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –í –ê–†–•–ò–í (–í–ú–ï–°–¢–û –£–î–ê–õ–ï–ù–ò–Ø)
        async function moveToArchive(ticketId) {
            if (!confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–∏–∫–µ—Ç –≤ –∞—Ä—Ö–∏–≤? –û–Ω –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ —Å–∫—Ä—ã—Ç –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.')) return;
            
            try {
                await db.collection('tickets').doc(ticketId).update({
                    status: 'archived',
                    archivedAt: new Date().toISOString(),
                    archivedBy: currentUser.email
                });
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –∞—Ä—Ö–∏–≤–µ
                const ticketDoc = await db.collection('tickets').doc(ticketId).get();
                await db.collection('archive').doc(ticketId).set({
                    ...ticketDoc.data(),
                    originalCollection: 'tickets',
                    archivedAt: new Date().toISOString(),
                    archivedBy: currentUser.email
                });
                
                showToast('‚úÖ –¢–∏–∫–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∞—Ä—Ö–∏–≤', 'success');
                loadTickets();
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                await db.collection('audit_log').add({
                    action: 'archive_ticket',
                    userId: currentUser.uid,
                    ticketId: ticketId,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏', 'danger');
            }
        }

        // üîÑ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò–ó –ê–†–•–ò–í–ê
        async function restoreFromArchive(ticketId) {
            try {
                const archiveDoc = await db.collection('archive').doc(ticketId).get();
                const ticketData = archiveDoc.data();
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ –æ—Å–Ω–æ–≤–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
                await db.collection('tickets').doc(ticketId).set({
                    ...ticketData,
                    status: 'new',
                    restoredAt: new Date().toISOString(),
                    restoredBy: currentUser.email
                }, { merge: true });
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ –∞—Ä—Ö–∏–≤–∞
                await db.collection('archive').doc(ticketId).delete();
                
                showToast('‚úÖ –¢–∏–∫–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∞—Ä—Ö–∏–≤–∞', 'success');
                loadTickets();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏', 'danger');
            }
        }

        // üíæ –≠–ö–°–ü–û–†–¢ –ë–ï–ö–ê–ü–ê
        async function exportBackup() {
            try {
                const snapshot = await db.collection('tickets').get();
                const tickets = [];
                
                snapshot.forEach(doc => {
                    tickets.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                const backup = {
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser.email,
                    ticketCount: tickets.length,
                    tickets: tickets
                };
                
                // –°–æ–∑–¥–∞–µ–º JSON —Ñ–∞–π–ª
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // –°–∫–∞—á–∏–≤–∞–µ–º
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `metro_new_backup_${Date.now()}.json`;
                link.click();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å –æ –±–µ–∫–∞–ø–µ
                await db.collection('backups').add({
                    timestamp: new Date().toISOString(),
                    createdBy: currentUser.email,
                    ticketCount: tickets.length,
                    filename: link.download
                });
                
                showToast('‚úÖ –ë–µ–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∫–∞–ø–∞:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–µ–∫–∞–ø–∞', 'danger');
            }
        }

        // üõ°Ô∏è –§–£–ù–ö–¶–ò–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
        function isAccountLocked() {
            if (loginAttempts >= SECURITY_CONFIG.maxLoginAttempts) {
                const timeSinceLastAttempt = Date.now() - lastFailedAttempt;
                return timeSinceLastAttempt < SECURITY_CONFIG.lockoutTime;
            }
            return false;
        }

        function isAllowedDomain(email) {
            return SECURITY_CONFIG.allowedDomains.some(domain => 
                email.endsWith(`@${domain}`) || email.includes(`@${domain}.`)
            );
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }

        function startSessionTimer() {
            if (sessionTimer) clearTimeout(sessionTimer);
            
            sessionTimer = setTimeout(() => {
                showToast('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'warning');
                logout();
            }, SECURITY_CONFIG.sessionTimeout);
        }

        // üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê
        async function loadStats() {
            try {
                const snapshot = await db.collection('tickets').get();
                const tickets = snapshot.docs.map(doc => doc.data());
                
                // –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const stats = {
                    total: tickets.length,
                    new: tickets.filter(t => t.status === 'new').length,
                    progress: tickets.filter(t => t.status === 'in-progress').length,
                    resolved: tickets.filter(t => t.status === 'resolved').length,
                    archived: tickets.filter(t => t.status === 'archived').length
                };
                
                // –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
                const responseTimes = tickets
                    .map(t => calculateResponseTime(t, true))
                    .filter(t => t !== null);
                
                const avgResponseTime = responseTimes.length > 0 
                    ? Math.round(responseTimes.reduce((a, b) => a + b) / responseTimes.length)
                    : 0;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('statTotal').textContent = stats.total;
                document.getElementById('statNew').textContent = stats.new;
                document.getElementById('statProgress').textContent = stats.progress;
                document.getElementById('statResolved').textContent = stats.resolved;
                document.getElementById('statResponseTime').textContent = `${avgResponseTime}–º`;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // üìù –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        function showLoginAlert(message, type) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showAdminPanel(adminData) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            document.getElementById('userName').textContent = adminData.name || currentUser.email;
            document.getElementById('userRole').textContent = adminData.roles?.join(', ') || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            document.getElementById('userAvatar').textContent = adminData.name?.[0] || 'A';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadTickets();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ —Å debounce
            let searchTimeout;
            document.getElementById('searchTickets').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(loadTickets, 300);
            });
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            document.getElementById('statusFilter').addEventListener('change', loadTickets);
            document.getElementById('priorityFilter').addEventListener('change', loadTickets);
        }

        function togglePassword() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleBtn = document.querySelector('.toggle-password i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.className = 'far fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleBtn.className = 'far fa-eye';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'üÜï –ù–æ–≤—ã–π',
                'in-progress': 'üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ',
                'resolved': '‚úÖ –†–µ—à–µ–Ω',
                'archived': 'üóÑÔ∏è –í –∞—Ä—Ö–∏–≤–µ'
            };
            return statusMap[status] || status;
        }

        function getPriorityText(priority) {
            const priorityMap = {
                'critical': 'üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π',
                'high': '‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π',
                'medium': 'üìù –°—Ä–µ–¥–Ω–∏–π',
                'low': '‚úÖ –ù–∏–∑–∫–∏–π'
            };
            return priorityMap[priority] || priority;
        }

        function getPriorityColor(priority) {
            const colorMap = {
                'critical': '#dc3545',
                'high': '#ff6b35',
                'medium': '#ffc107',
                'low': '#28a745'
            };
            return colorMap[priority] || '#6c757d';
        }

        function getPositionText(position) {
            const positionMap = {
                'player': 'üéÆ –ò–≥—Ä–æ–∫',
                'developer': 'üíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
                'moderator': 'üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
                'admin': 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
            };
            return positionMap[position] || position;
        }

        function calculateResponseTime(ticket, returnMinutes = false) {
            if (ticket.assignedAt && ticket.resolvedAt) {
                const assigned = new Date(ticket.assignedAt);
                const resolved = new Date(ticket.resolvedAt);
                const minutes = Math.round((resolved - assigned) / (1000 * 60));
                
                if (returnMinutes) return minutes;
                
                if (minutes < 60) return `${minutes} –º–∏–Ω—É—Ç`;
                if (minutes < 1440) return `${Math.floor(minutes/60)} —á–∞—Å–æ–≤`;
                return `${Math.floor(minutes/1440)} –¥–Ω–µ–π`;
            }
            return null;
        }

        function ticketMatchesSearch(ticket, query) {
            const searchFields = [
                ticket.id,
                ticket.name,
                ticket.email,
                ticket.message,
                ticket.contactDetails
            ];
            
            return searchFields.some(field => 
                field && field.toString().toLowerCase().includes(query)
            );
        }

        // üéØ –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –¢–ò–ö–ï–¢–ê
        async function updateTicket(ticketId, newStatus) {
            try {
                await db.collection('tickets').doc(ticketId).update({
                    status: newStatus,
                    assignedTo: currentUser.email,
                    updatedAt: new Date().toISOString(),
                    [newStatus === 'in-progress' ? 'assignedAt' : 'resolvedAt']: new Date().toISOString()
                });
                
                showToast(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${getStatusText(newStatus)}`, 'success');
                loadTickets();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'danger');
            }
        }

        // üìù –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–ò–ö–ï–¢–ê
        async function openEditModal(ticketId) {
            try {
                const ticketDoc = await db.collection('tickets').doc(ticketId).get();
                const ticket = ticketDoc.data();
                
                document.getElementById('modalContent').innerHTML = `
                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="editStatus" class="form-control">
                            <option value="new" ${ticket.status === 'new' ? 'selected' : ''}>üÜï –ù–æ–≤—ã–π</option>
                            <option value="in-progress" ${ticket.status === 'in-progress' ? 'selected' : ''}>üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="resolved" ${ticket.status === 'resolved' ? 'selected' : ''}>‚úÖ –†–µ—à–µ–Ω</option>
                            <option value="archived" ${ticket.status === 'archived' ? 'selected' : ''}>üóÑÔ∏è –ê—Ä—Ö–∏–≤</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select id="editPriority" class="form-control">
                            <option value="low" ${ticket.priority === 'low' ? 'selected' : ''}>‚úÖ –ù–∏–∑–∫–∏–π</option>
                            <option value="medium" ${ticket.priority === 'medium' ? 'selected' : ''}>üìù –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="high" ${ticket.priority === 'high' ? 'selected' : ''}>‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π</option>
                            <option value="critical" ${ticket.priority === 'critical' ? 'selected' : ''}>üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–ù–∞–∑–Ω–∞—á–µ–Ω–æ</label>
                        <input type="text" id="editAssigned" class="form-control" value="${ticket.assignedTo || ''}" placeholder="Email –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ">
                    </div>
                    
                    <div class="form-group">
                        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="editComment" class="form-control" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">${ticket.comment || ''}</textarea>
                    </div>
                    
                    <button class="btn" onclick="saveTicketChanges('${ticketId}')">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                `;
                
                document.getElementById('editModal').style.display = 'flex';
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∏–∫–µ—Ç–∞', 'danger');
            }
        }

        async function saveTicketChanges(ticketId) {
            try {
                await db.collection('tickets').doc(ticketId).update({
                    status: document.getElementById('editStatus').value,
                    priority: document.getElementById('editPriority').value,
                    assignedTo: document.getElementById('editAssigned').value.trim(),
                    comment: document.getElementById('editComment').value.trim(),
                    updatedAt: new Date().toISOString(),
                    lastEditedBy: currentUser.email
                });
                
                closeModal();
                showToast('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                loadTickets();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π', 'danger');
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function showArchived() {
            document.getElementById('statusFilter').value = 'archived';
            loadTickets();
        }

        // üì± –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û–°–¢–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        function trackUserActivity() {
            let timeout;
            
            function resetTimer() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    if (currentUser) {
                        showToast('–ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –°–µ—Å—Å–∏—è —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç.', 'warning');
                    }
                }, SECURITY_CONFIG.sessionTimeout - 60000); // –ó–∞ –º–∏–Ω—É—Ç—É –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
            }
            
            // –°–æ–±—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
                document.addEventListener(event, resetTimer);
            });
            
            resetTimer();
        }

        // üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const adminDoc = await db.collection('admins').doc(user.uid).get();
                        if (adminDoc.exists) {
                            currentUser = user;
                            showAdminPanel(adminDoc.data());
                            trackUserActivity();
                        } else {
                            await auth.signOut();
                        }
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤:', error);
                    }
                }
            });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });

        // ‚ö†Ô∏è FALLBACK –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –ë–ï–ó –ò–ù–î–ï–ö–°–û–í
        async function loadTicketsFallback() {
            try {
                const snapshot = await db.collection('tickets').get();
                const tickets = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                const statusFilter = document.getElementById('statusFilter').value;
                const filteredTickets = tickets.filter(t => 
                    statusFilter === 'all' || t.status === statusFilter
                );
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                const ticketsList = document.getElementById('ticketsList');
                if (filteredTickets.length === 0) {
                    ticketsList.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>–¢–∏–∫–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3></div>';
                    return;
                }
                
                ticketsList.innerHTML = filteredTickets.map(t => renderTicket(t.id, t)).join('');
                
            } catch (error) {
                console.error('‚ùå Fallback –æ—à–∏–±–∫–∞:', error);
            }
        }
    </script>
</body>
</html>
