<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Метро New Verification</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    ul { list-style: disc; padding-left: 20px; }
    .status { font-weight: bold; }
    .allowed { color: green; }
    .denied { color: red; }
  </style>
</head>
<body>
  <h1>Авторизация через Discord</h1>
  <div id="content"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const content = document.getElementById('content');

    if (!token) {
      content.innerHTML = `
        <p>Пользователь не авторизован</p>
        <a href="https://metro-new-auth.kirilltyr123.workers.dev/login">Войти через Discord</a>
      `;
    } else {
      try {
        const [headerB64, payloadB64, signature] = token.split(".");
        const payload = JSON.parse(atob(payloadB64));

        // ID твоего сервера
        const allowedGuilds = ["1220060387639038063"];
        const isAllowed = payload.guilds.some(g => allowedGuilds.includes(g));

        content.innerHTML = `
          <h2>Привет, ${payload.username}</h2>
          <p>Discord ID: ${payload.discord_id}</p>
          <p>Список серверов пользователя:</p>
          <ul>
            ${payload.guilds.map(id => `<li>${id} ${
              allowedGuilds.includes(id) ? '<span class="allowed">✅ доступ разрешён</span>' : '<span class="denied">❌ нет доступа</span>'
            }</li>`).join("")}
          </ul>
          <p class="status">Доступ к твоему серверу: ${isAllowed ? '<span class="allowed">✅ Разрешён</span>' : '<span class="denied">❌ Не разрешён</span>'}</p>
          <p>Токен истекает: ${new Date(payload.exp * 1000).toLocaleString()}</p>
        `;
      } catch (e) {
        content.innerHTML = `<p>Ошибка при обработке токена: ${e.message}</p>`;
      }
    }
  </script>
</body>
</html>
