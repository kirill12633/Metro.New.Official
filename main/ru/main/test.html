<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</title>
<style>
  body { font-family: Arial; padding: 20px; }
  input, textarea { width: 300px; margin-bottom: 10px; }
  #status { margin-top: 10px; color: green; }
</style>
</head>
<body>

<h2>–§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</h2>

<form id="feedbackForm">
  <label>–í–∞—à–µ –∏–º—è:</label><br>
  <input type="text" id="name" required><br>

  <label>Email:</label><br>
  <input type="email" id="email" required><br>

  <label>–¢–µ–º–∞:</label><br>
  <input type="text" id="subject" required><br>

  <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label><br>
  <textarea id="message" required></textarea><br>

  <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>

<p id="status"></p>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js"></script>

<script>
// üîπ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
  authDomain: "metro-new-85226.firebaseapp.com",
  projectId: "metro-new-85226",
  storageBucket: "metro-new-85226.appspot.com",
  messagingSenderId: "905640751733",
  appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// üîπ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
auth.signInAnonymously().catch(console.error);

// üîπ App Check (reCAPTCHA v3)
firebase.appCheck().activate(
  "–í–ê–®_SITE_KEY_IZ_RECAPTCHA_v3", // –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π site key
  true // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
);

const status = document.getElementById("status");

// üîπ –ñ–¥—ë–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –≤–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—É
firebase.auth().onAuthStateChanged(user => {
  if (!user) return; // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
  const uid = user.uid;

  const form = document.getElementById("feedbackForm");
  let canSend = true;

  function startCooldown() {
    canSend = false;
    setTimeout(() => canSend = true, 10*60*1000); // 10 –º–∏–Ω—É—Ç
  }

  form.addEventListener("submit", async function(e) {
    e.preventDefault();

    if (!canSend) {
      status.innerText = "‚è≥ –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç!";
      return;
    }

    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const subject = document.getElementById("subject").value.trim();
    const message = document.getElementById("message").value.trim();

    // üîπ –∞–Ω—Ç–∏-–±–æ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (message.length < 5 || message.length > 2000) {
      status.innerText = "‚ö† –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ.";
      return;
    }

    try {
      await db.collection("feedback").add({
        uid: uid,
        name,
        email,
        subject,
        message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      status.innerText = "‚úî –°–ø–∞—Å–∏–±–æ! –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!";
      form.reset();
      startCooldown();
    } catch(err) {
      status.innerText = "‚ùå –û—à–∏–±–∫–∞: " + err.message;
      console.error(err);
    }
  });
});
</script>

</body>
</html>
