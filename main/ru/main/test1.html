<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</title>
<style>
  body { font-family: Arial; padding: 20px; }
  input, textarea { width: 300px; margin-bottom: 10px; }
  #status { margin-top: 10px; font-weight: bold; color: green; }
</style>
</head>
<body>

<h2>–§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</h2>

<form id="feedbackForm">
  <label>–í–∞—à–µ –∏–º—è:</label><br>
  <input type="text" id="name" required><br>

  <label>Email:</label><br>
  <input type="email" id="email" required><br>

  <label>–¢–µ–º–∞:</label><br>
  <input type="text" id="subject" required><br>

  <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label><br>
  <textarea id="message" required></textarea><br>

  <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>

<p id="status"></p>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js"></script>

<script>
// üîπ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
  authDomain: "metro-new-85226.firebaseapp.com",
  projectId: "metro-new-85226",
  storageBucket: "metro-new-85226.appspot.com",
  messagingSenderId: "905640751733",
  appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const status = document.getElementById("status");

// üîπ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
auth.signInAnonymously().catch(err => console.error("Auth error:", err));

// üîπ App Check
firebase.appCheck().activate(
  "6LfhAZkrAAAAAO1NxGCMX1J2HKiDp01FW9AuHR7r", // —Ç–≤–æ–π site key
  true
);

let canSend = true; // cooldown —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

firebase.auth().onAuthStateChanged(user => {
  if (!user) return; // –∂–¥—ë–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const uid = user.uid;

  const form = document.getElementById("feedbackForm");

  function startCooldown() {
    canSend = false;
    status.innerText = "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º";
    setTimeout(() => {
      canSend = true;
      status.innerText = "";
    }, 10*60*1000);
  }

  form.addEventListener("submit", async function(e) {
    e.preventDefault();

    if (!canSend) {
      status.innerText = "‚è≥ –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç!";
      return;
    }

    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const subject = document.getElementById("subject").value.trim();
    const message = document.getElementById("message").value.trim();

    if (message.length < 5 || message.length > 2000) {
      status.innerText = "‚ö† –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ.";
      return;
    }

    try {
      const docRef = await db.collection("feedback").add({
        uid: uid,
        name,
        email,
        subject,
        message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log("–î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω:", docRef.id); // –ª–æ–≥ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
      status.innerText = "‚úî –°–ø–∞—Å–∏–±–æ! –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!";
      form.reset();
      startCooldown();
    } catch(err) {
      console.error("–û—à–∏–±–∫–∞ Firestore:", err);
      status.innerText = "‚ùå –û—à–∏–±–∫–∞: " + err.message;
    }
  });
});
</script>

</body>
</html>
