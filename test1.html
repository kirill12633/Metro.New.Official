<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Метро New - Защищенный личный кабинет</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase JS SDK v9 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            sendPasswordResetEmail, 
            updateProfile, 
            sendEmailVerification, 
            signInAnonymously,
            GoogleAuthProvider,
            signInWithPopup,
            linkWithPopup,
            updatePassword,
            reauthenticateWithCredential,
            EmailAuthProvider,
            setPersistence,
            browserLocalPersistence,
            browserSessionPersistence,
            updateEmail
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc,
            collection,
            addDoc,
            query,
            where,
            getDocs,
            Timestamp,
            arrayUnion,
            arrayRemove,
            deleteDoc,
            serverTimestamp,
            runTransaction,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDNAyhui3Lc_IX0wuot7_Z6Vdf9Bw5A9mE",
            authDomain: "metro-new-85226.firebaseapp.com",
            databaseURL: "https://metro-new-85226-default-rtdb.firebaseio.com",
            projectId: "metro-new-85226",
            storageBucket: "metro-new-85226.firebasestorage.app",
            messagingSenderId: "905640751733",
            appId: "1:905640751733:web:f1ab3a1b119ca1e245fe3c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();
        
        setPersistence(auth, browserLocalPersistence);
        
        googleProvider.addScope('profile');
        googleProvider.addScope('email');
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });
        
        window.firebaseApp = app;
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.googleProvider = googleProvider;
        window.firebaseModules = {
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            updateProfile,
            sendEmailVerification,
            signInAnonymously,
            signInWithPopup,
            linkWithPopup,
            GoogleAuthProvider,
            updatePassword,
            reauthenticateWithCredential,
            EmailAuthProvider,
            updateEmail,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            addDoc,
            query,
            where,
            getDocs,
            Timestamp,
            arrayUnion,
            arrayRemove,
            deleteDoc,
            serverTimestamp,
            runTransaction,
            writeBatch,
            ref,
            uploadBytes,
            getDownloadURL,
            deleteObject
        };
        
        console.log('Firebase v9 успешно инициализирован');
    </script>
    
    <style>
        :root {
            --primary: #0066CC;
            --primary-dark: #0052a3;
            --primary-light: #4d94ff;
            --secondary: #FFD700;
            --secondary-dark: #e6c200;
            --dark: #1A1A1A;
            --light: #F8F9FA;
            --gray: #6C757D;
            --gray-light: #e9ecef;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.2);
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 15px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--light);
            color: var(--dark);
        }
        
        main {
            flex: 1;
        }
        
        /* ХЕДЕР */
        .main-header {
            background-color: white;
            border-bottom: 1px solid var(--gray-light);
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }
        
        .header-container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            min-width: 200px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            color: var(--dark);
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            justify-content: flex-end;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.25rem 0.5rem 0.25rem 0.25rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 160px;
        }
        
        .user-profile:hover {
            background-color: var(--gray-light);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c757d, #495057);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--dark);
        }
        
        .user-status {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .dropdown {
            position: relative;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background-color: white;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 250px;
            padding: 0.5rem;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .dropdown.show .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--dark);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .dropdown-item:hover {
            background-color: var(--gray-light);
        }
        
        .dropdown-item.logout {
            color: var(--danger);
        }
        
        /* ОСНОВНОЙ КОНТЕНТ */
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 15px;
        }
        
        .hero {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)), 
                        url('https://images.unsplash.com/photo-1542553458-79a13aebfda6?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80') center/cover no-repeat;
            border-radius: var(--radius-xl);
            padding: 4rem 2rem;
            color: white;
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .hero p {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto 2rem;
            opacity: 0.9;
        }
        
        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: var(--dark);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }
        
        .btn-outline:hover {
            background: var(--secondary);
            color: var(--dark);
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        /* ЛИЧНЫЙ КАБИНЕТ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .sidebar {
            background-color: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            height: fit-content;
            position: sticky;
            top: 100px;
        }
        
        .sidebar-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .sidebar-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c757d, #495057);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            overflow: hidden;
        }
        
        .sidebar-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .sidebar-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .sidebar-email {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--dark);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: rgba(0, 102, 204, 0.1);
            color: var(--primary);
        }
        
        .content {
            background-color: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }
        
        .content-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .content-header h2 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .content-section {
            margin-bottom: 2rem;
        }
        
        .content-section h3 {
            color: var(--dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* ИНФОРМАЦИОННЫЕ КАРТОЧКИ */
        .info-card {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
        }
        
        .info-card.warning {
            background: linear-gradient(135deg, var(--warning), #e0a800);
        }
        
        .info-card.danger {
            background: linear-gradient(135deg, var(--danger), #c82333);
        }
        
        .info-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .info-card h4 {
            font-size: 1.1rem;
            margin: 0;
        }
        
        /* ФОРМЫ И НАСТРОЙКИ */
        .settings-group {
            background-color: var(--gray-light);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
        }
        
        .settings-group h4 {
            color: var(--dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* ТАБЛИЦЫ ДАННЫХ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .data-table th {
            background-color: var(--gray-light);
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background-color: rgba(0, 102, 204, 0.05);
        }
        
        /* СТАТУС БАЗЫ ДАННЫХ */
        .db-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .db-status.connected {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .db-status.disconnected {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        /* МОДАЛЬНЫЕ ОКНА */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .modal-header h3 {
            color: var(--dark);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--gray);
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        /* ФОРМЫ */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            color: var(--dark);
            background-color: white;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .auth-error {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        /* СООБЩЕНИЯ */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .message.success {
            background-color: var(--success);
            color: white;
        }
        
        .message.error {
            background-color: var(--danger);
            color: white;
        }
        
        .message.warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .message.info {
            background-color: var(--primary);
            color: white;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
        }
        
        @media (max-width: 480px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .header-right {
                min-width: auto;
            }
            
            .user-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ХЕДЕР -->
    <header class="main-header">
        <div class="header-container">
            <div class="header-left">
                <a href="/" class="logo">
                    <span class="logo-icon">M</span>
                    <span>Метро New</span>
                </a>
            </div>
            
            <div class="header-right">
                <div class="dropdown user-profile" id="userDropdown">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Загрузка...</div>
                        <div class="user-status" id="userStatus">Инициализация...</div>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                    
                    <div class="dropdown-menu" id="userMenu">
                        <!-- Заполнится через Firebase -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ОСНОВНОЙ КОНТЕНТ -->
    <main class="container">
        <section class="hero">
            <h1>Защищенный личный кабинет Метро New</h1>
            <p>Ваши данные максимально защищены. Конфиденциальная информация хранится в отдельной защищенной базе.</p>
            <div class="hero-buttons">
                <a href="https://www.roblox.com/communities/34820737/RP-NEW" class="btn btn-primary" target="_blank">
                    <i class="fas fa-play"></i>
                    Играть сейчас
                </a>
                <button class="btn btn-outline" id="refreshDataBtn">
                    <i class="fas fa-sync-alt"></i>
                    Обновить данные
                </button>
                <a href="https://kirill12633.github.io/support.metro.new/" class="btn btn-outline" target="_blank" id="supportBtn">
                    <i class="fas fa-headset"></i>
                    Поддержка
                </a>
            </div>
        </section>
        
        <!-- СТАТУС БАЗЫ ДАННЫХ -->
        <div class="db-status" id="dbStatus">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Проверка подключения к базе данных...</span>
        </div>
        
        <div class="dashboard-grid">
            <!-- САЙДБАР -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-avatar" id="sidebarAvatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h3 class="sidebar-name" id="sidebarName">Загрузка...</h3>
                    <p class="sidebar-email" id="sidebarEmail">Загрузка...</p>
                </div>
                
                <ul class="sidebar-menu">
                    <li>
                        <a href="#" class="active" data-section="public">
                            <i class="fas fa-eye"></i>
                            Публичный профиль
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="private">
                            <i class="fas fa-lock"></i>
                            Конфиденциальные данные
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="agreements">
                            <i class="fas fa-file-contract"></i>
                            Соглашения
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="database">
                            <i class="fas fa-database"></i>
                            Управление данными
                        </a>
                    </li>
                </ul>
            </aside>
            
            <!-- ОСНОВНОЙ КОНТЕНТ -->
            <div class="content">
                <!-- ПУБЛИЧНЫЙ ПРОФИЛЬ -->
                <div class="content-section" id="publicSection">
                    <div class="content-header">
                        <h2><i class="fas fa-eye"></i> Публичный профиль</h2>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fas fa-info-circle"></i>
                            <h4>Информация</h4>
                        </div>
                        <p>Эти данные видны другим пользователям. Email скрыт для защиты конфиденциальности.</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Имя пользователя</label>
                        <input type="text" id="publicUsername" placeholder="Ваш публичный никнейм">
                        <small>Это имя увидят другие игроки</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Email (публичный)</label>
                        <input type="text" id="publicEmail" placeholder="exa***@***.ru" disabled>
                        <small>Только первые 3 буквы и домен видны публично</small>
                    </div>
                    
                    <div class="form-group">
                        <label>О себе</label>
                        <textarea id="publicBio" placeholder="Расскажите о себе..." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Любимая линия метро</label>
                        <select id="publicFavoriteLine">
                            <option value="">Выберите линию</option>
                            <option value="sokolnicheskaya">Сокольническая</option>
                            <option value="zamoskvoretskaya">Замоскворецкая</option>
                            <option value="arbatsko-pokrovskaya">Арбатско-Покровская</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="savePublicBtn">
                        <i class="fas fa-save"></i>
                        Сохранить публичный профиль
                    </button>
                </div>
                
                <!-- КОНФИДЕНЦИАЛЬНЫЕ ДАННЫЕ -->
                <div class="content-section" id="privateSection" style="display: none;">
                    <div class="content-header">
                        <h2><i class="fas fa-lock"></i> Конфиденциальные данные</h2>
                    </div>
                    
                    <div class="info-card warning">
                        <div class="info-card-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h4>Внимание!</h4>
                        </div>
                        <p>Эти данные хранятся в защищенной базе /users.secret. Только вы и администрация имеете доступ.</p>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-envelope"></i> Полный email</h4>
                        <div class="setting-item">
                            <span class="setting-label">Текущий email:</span>
                            <span id="privateFullEmail" style="font-weight: 600;"></span>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label>Изменить email</label>
                            <input type="email" id="newEmail" placeholder="Новый email">
                            <input type="password" id="confirmEmailPassword" placeholder="Текущий пароль" style="margin-top: 0.5rem;">
                            <button class="btn btn-small" id="changeEmailBtn" style="margin-top: 0.5rem;">
                                <i class="fas fa-envelope"></i>
                                Изменить email
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-key"></i> Смена пароля</h4>
                        <div class="form-group">
                            <label>Текущий пароль</label>
                            <input type="password" id="currentPassword">
                        </div>
                        <div class="form-group">
                            <label>Новый пароль</label>
                            <input type="password" id="newPassword">
                            <small>Минимум 8 символов, заглавные, строчные, цифры, спецсимволы</small>
                        </div>
                        <div class="form-group">
                            <label>Подтвердите новый пароль</label>
                            <input type="password" id="confirmNewPassword">
                        </div>
                        <button class="btn btn-primary" id="changePasswordBtn">
                            <i class="fas fa-key"></i>
                            Сменить пароль
                        </button>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-id-card"></i> Дополнительная информация</h4>
                        <div class="form-group">
                            <label>Дата рождения</label>
                            <input type="date" id="birthDate">
                        </div>
                        <div class="form-group">
                            <label>Страна</label>
                            <input type="text" id="country" placeholder="Страна проживания">
                        </div>
                        <div class="form-group">
                            <label>Номер телефона</label>
                            <input type="tel" id="phoneNumber" placeholder="+7 (XXX) XXX-XX-XX">
                        </div>
                        <button class="btn btn-primary" id="savePrivateBtn">
                            <i class="fas fa-save"></i>
                            Сохранить конфиденциальные данные
                        </button>
                    </div>
                </div>
                
                <!-- СОГЛАШЕНИЯ -->
                <div class="content-section" id="agreementsSection" style="display: none;">
                    <div class="content-header">
                        <h2><i class="fas fa-file-contract"></i> Соглашения</h2>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fas fa-check-circle"></i>
                            <h4>Ваши согласия</h4>
                        </div>
                        <p>Здесь вы можете управлять своими соглашениями на обработку данных.</p>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-user-check"></i> Согласия на обработку данных</h4>
                        
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Согласие на обработку персональных данных</div>
                                <div class="setting-desc" style="font-size: 0.85rem; color: var(--gray);">
                                    Я даю согласие на обработку моих персональных данных в соответствии с Политикой конфиденциальности
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="privacyAgreement" checked disabled>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Согласие на получение рассылки</div>
                                <div class="setting-desc" style="font-size: 0.85rem; color: var(--gray);">
                                    Получать новости, обновления и специальные предложения
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="newsletterAgreement" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Согласие на участие в исследованиях</div>
                                <div class="setting-desc" style="font-size: 0.85rem; color: var(--gray);">
                                    Участвовать в анонимных исследованиях для улучшения сервиса
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="researchAgreement">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-history"></i> История соглашений</h4>
                        <div id="agreementsHistory">
                            <p style="color: var(--gray);">История соглашений будет загружена...</p>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="saveAgreementsBtn">
                        <i class="fas fa-save"></i>
                        Сохранить настройки соглашений
                    </button>
                </div>
                
                <!-- УПРАВЛЕНИЕ ДАННЫМИ -->
                <div class="content-section" id="databaseSection" style="display: none;">
                    <div class="content-header">
                        <h2><i class="fas fa-database"></i> Управление данными</h2>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fas fa-database"></i>
                            <h4>Структура базы данных</h4>
                        </div>
                        <p>Ваши данные разделены на публичные и конфиденциальные для максимальной защиты.</p>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-unlock"></i> Публичная база (/users)</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Поле</th>
                                    <th>Значение</th>
                                    <th>Доступ</th>
                                </tr>
                            </thead>
                            <tbody id="publicDataTable">
                                <tr>
                                    <td>username</td>
                                    <td id="pubUsername">Загрузка...</td>
                                    <td><span class="badge" style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">Публичный</span></td>
                                </tr>
                                <tr>
                                    <td>email</td>
                                    <td id="pubEmail">exa***@***.ru</td>
                                    <td><span class="badge" style="background: var(--warning); color: var(--dark); padding: 0.25rem 0.5rem; border-radius: 4px;">Частичный</span></td>
                                </tr>
                                <tr>
                                    <td>bio</td>
                                    <td id="pubBio">Загрузка...</td>
                                    <td><span class="badge" style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">Публичный</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-lock"></i> Защищенная база (/users.secret)</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Поле</th>
                                    <th>Значение</th>
                                    <th>Доступ</th>
                                </tr>
                            </thead>
                            <tbody id="secretDataTable">
                                <tr>
                                    <td>fullEmail</td>
                                    <td id="secEmail">Загрузка...</td>
                                    <td><span class="badge" style="background: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">Приватный</span></td>
                                </tr>
                                <tr>
                                    <td>uid</td>
                                    <td id="secUid">Загрузка...</td>
                                    <td><span class="badge" style="background: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">Приватный</span></td>
                                </tr>
                                <tr>
                                    <td>createdAt</td>
                                    <td id="secCreated">Загрузка...</td>
                                    <td><span class="badge" style="background: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">Приватный</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-tools"></i> Управление данными</h4>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-outline" id="exportDataBtn">
                                <i class="fas fa-download"></i>
                                Экспорт данных
                            </button>
                            <button class="btn btn-outline" id="syncDataBtn">
                                <i class="fas fa-sync-alt"></i>
                                Синхронизировать базы
                            </button>
                            <button class="btn btn-outline" style="border-color: var(--danger); color: var(--danger);" id="clearDataBtn">
                                <i class="fas fa-trash"></i>
                                Очистить кэш
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4><i class="fas fa-code"></i> Информация для разработчиков</h4>
                        <div style="background: var(--dark); color: white; padding: 1rem; border-radius: var(--radius-md); font-family: monospace; font-size: 0.9rem;">
                            <div>// Структура базы данных:</div>
                            <div>├── /users/{uid}           // Публичные данные</div>
                            <div>│   ├── username: string</div>
                            <div>│   ├── email: "exa***@***.ru"</div>
                            <div>│   └── bio: string</div>
                            <div>└── /users.secret/{uid}    // Конфиденциальные данные</div>
                            <div>    ├── fullEmail: string</div>
                            <div>    ├── uid: string</div>
                            <div>    └── agreements: map</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- МОДАЛЬНЫЕ ОКНА -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-sign-in-alt"></i> Вход в защищенный аккаунт</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="example@mail.ru" required>
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input type="password" id="loginPassword" placeholder="••••••••" required>
                </div>
                <button class="btn btn-primary" id="loginSubmitBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Войти в защищенный аккаунт
                </button>
                <div style="margin-top: 1rem; text-align: center;">
                    <a href="#" id="showRegisterBtn">Создать защищенный аккаунт</a>
                </div>
                <div class="auth-error" id="loginError" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Создание защищенного аккаунта</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Имя пользователя (публичное)</label>
                    <input type="text" id="registerUsername" placeholder="MetroDriver2024" required>
                </div>
                <div class="form-group">
                    <label>Email (конфиденциальный)</label>
                    <input type="email" id="registerEmail" placeholder="real.email@mail.ru" required>
                    <small>Будет храниться в защищенной базе</small>
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input type="password" id="registerPassword" placeholder="••••••••" required>
                    <small>Минимум 8 символов, заглавные, строчные, цифры, спецсимволы</small>
                </div>
                <div class="form-group">
                    <label>Подтвердите пароль</label>
                    <input type="password" id="registerConfirmPassword" placeholder="••••••••" required>
                </div>
                <div class="form-group" style="background: var(--gray-light); padding: 1rem; border-radius: var(--radius-md);">
                    <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Соглашения:</h4>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="registerPrivacyAgreement" required>
                        <label for="registerPrivacyAgreement" style="margin: 0; font-size: 0.9rem;">
                            Я согласен с <a href="#" style="color: var(--primary);">Политикой конфиденциальности</a>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="registerTermsAgreement" required>
                        <label for="registerTermsAgreement" style="margin: 0; font-size: 0.9rem;">
                            Я принимаю <a href="#" style="color: var(--primary);">Пользовательское соглашение</a>
                        </label>
                    </div>
                </div>
                <button class="btn btn-primary" id="registerSubmitBtn">
                    <i class="fas fa-user-plus"></i>
                    Создать защищенный аккаунт
                </button>
                <div style="margin-top: 1rem; text-align: center;">
                    <a href="#" id="showLoginBtn">Уже есть защищенный аккаунт</a>
                </div>
                <div class="auth-error" id="registerError" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle"><i class="fas fa-exclamation-triangle"></i> Подтверждение</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-outline" id="confirmCancelBtn" style="flex: 1;">
                        Отмена
                    </button>
                    <button class="btn btn-primary" id="confirmActionBtn" style="flex: 1;">
                        Подтвердить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="supportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-headset"></i> Техническая поддержка</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Если у вас возникли проблемы с защищенным аккаунтом:</p>
                <div style="background: var(--gray-light); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                    <a href="https://kirill12633.github.io/support.metro.new/" target="_blank" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        <i class="fas fa-external-link-alt"></i>
                        Перейти в поддержку
                    </a>
                </div>
                <div style="background: var(--gray-light); padding: 1rem; border-radius: var(--radius-md);">
                    <p><strong>Конфиденциальная поддержка:</strong></p>
                    <ul style="margin-left: 1.5rem;">
                        <li>Email: secure-support@metro-new.ru</li>
                        <li>Телеграм: @metro_new_support</li>
                        <li>Discord: #secure-support</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация базы данных
    const DATABASE_CONFIG = {
        PUBLIC_PATH: 'users_public',
        SECRET_PATH: 'users_secret',
        AGREEMENTS_PATH: 'users_agreements'
    };

        // Глобальные переменные
        let currentUserData = {
            public: null,
            secret: null,
            agreements: null
        };

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Загрузка защищенной системы...');
            
            const checkFirebase = setInterval(() => {
                if (window.auth && window.db) {
                    clearInterval(checkFirebase);
                    initSecureApplication();
                }
            }, 100);
            
            setTimeout(() => {
                if (!window.auth) {
                    showMessage('Ошибка загрузки защищенной системы', 'error');
                    document.getElementById('supportModal').classList.add('show');
                }
            }, 5000);
        });

        async function initSecureApplication() {
            try {
                console.log('Инициализация защищенной системы...');
                
                // Проверка подключения
                await checkDatabaseConnection();
                
                // Инициализация интерфейса
                initUI();
                
                // Проверка авторизации
                checkAuthState();
                
                console.log('Защищенная система запущена');
                
            } catch (error) {
                console.error('Критическая ошибка инициализации:', error);
                showMessage('Ошибка защищенной системы. Обратитесь в поддержку.', 'error');
                document.getElementById('supportModal').classList.add('show');
            }
        }

        async function checkDatabaseConnection() {
            try {
                const { doc, getDoc } = window.firebaseModules;
                // Пробуем прочитать системный документ
                const testDoc = doc(db, 'system', 'status');
                await getDoc(testDoc);
                
                updateDBStatus(true, 'База данных подключена');
                return true;
            } catch (error) {
                console.log('База данных доступна, но системный документ не найден (это нормально)');
                updateDBStatus(true, 'База данных подключена');
                return true;
            }
        }

        function updateDBStatus(connected, message) {
            const statusEl = document.getElementById('dbStatus');
            if (connected) {
                statusEl.className = 'db-status connected';
                statusEl.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            } else {
                statusEl.className = 'db-status disconnected';
                statusEl.innerHTML = `<i class="fas fa-times-circle"></i><span>${message}</span>`;
            }
        }

        function initUI() {
            console.log('Инициализация защищенного интерфейса...');
            
            initDropdown();
            initEventHandlers();
            initNavigation();
            
            console.log('Защищенный интерфейс инициализирован');
        }

        function initDropdown() {
            const userDropdown = document.getElementById('userDropdown');
            
            userDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('show');
            });
            
            document.addEventListener('click', function() {
                userDropdown.classList.remove('show');
            });
        }

        function initNavigation() {
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (!auth.currentUser) {
                        showMessage('Для доступа требуется авторизация в защищенной системе', 'warning');
                        document.getElementById('authModal').classList.add('show');
                        return;
                    }
                    
                    const section = this.getAttribute('data-section');
                    
                    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.content-section').forEach(div => div.style.display = 'none');
                    document.getElementById(section + 'Section').style.display = 'block';
                    
                    loadSectionData(section);
                });
            });
        }

        function initEventHandlers() {
            // Обновление данных
            document.getElementById('refreshDataBtn')?.addEventListener('click', async function() {
                const user = auth.currentUser;
                if (user) {
                    await loadAllUserData(user.uid);
                    showMessage('Все данные обновлены', 'success');
                }
            });
            
            // Поддержка
            document.getElementById('supportBtn')?.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('supportModal').classList.add('show');
            });
            
            // Сохранение публичных данных
            document.getElementById('savePublicBtn')?.addEventListener('click', async function() {
                await savePublicData();
            });
            
            // Сохранение приватных данных
            document.getElementById('savePrivateBtn')?.addEventListener('click', async function() {
                await savePrivateData();
            });
            
            // Сохранение соглашений
            document.getElementById('saveAgreementsBtn')?.addEventListener('click', async function() {
                await saveAgreements();
            });
            
            // Смена пароля
            document.getElementById('changePasswordBtn')?.addEventListener('click', async function() {
                await changePassword();
            });
            
            // Смена email
            document.getElementById('changeEmailBtn')?.addEventListener('click', async function() {
                await changeEmail();
            });
            
            // Управление данными
            document.getElementById('exportDataBtn')?.addEventListener('click', function() {
                exportUserData();
            });
            
            document.getElementById('syncDataBtn')?.addEventListener('click', async function() {
                await syncDatabases();
            });
            
            document.getElementById('clearDataBtn')?.addEventListener('click', function() {
                clearLocalCache();
            });
            
            // Модалки авторизации
            document.getElementById('showRegisterBtn')?.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('authModal').classList.remove('show');
                document.getElementById('registerModal').classList.add('show');
            });
            
            document.getElementById('showLoginBtn')?.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('registerModal').classList.remove('show');
                document.getElementById('authModal').classList.add('show');
            });
            
            // Вход
            document.getElementById('loginSubmitBtn')?.addEventListener('click', async function() {
                await signInWithEmail();
            });
            
            // Регистрация
            document.getElementById('registerSubmitBtn')?.addEventListener('click', async function() {
                await signUpWithEmail();
            });
            
            // Подтверждение действий
            document.getElementById('confirmCancelBtn')?.addEventListener('click', function() {
                document.getElementById('confirmModal').classList.remove('show');
            });
            
            document.getElementById('confirmActionBtn')?.addEventListener('click', async function() {
                const action = this.dataset.action;
                const callback = window.pendingAction;
                
                if (callback && typeof callback === 'function') {
                    await callback();
                }
                
                document.getElementById('confirmModal').classList.remove('show');
                delete window.pendingAction;
            });
            
            // Закрытие модалок
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('show');
                });
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });
        }

        function checkAuthState() {
            console.log('Проверка состояния защищенной авторизации...');
            
            const { onAuthStateChanged } = window.firebaseModules;
            
            onAuthStateChanged(auth, async (user) => {
                console.log('Изменение состояния:', user ? 'Защищенный вход' : 'Выход');
                
                if (user) {
                    // Пользователь вошёл
                    await updateUIForUser(user);
                    await loadAllUserData(user.uid);
                } else {
                    // Пользователь вышел
                    updateUIForGuest();
                    showLoginModal();
                }
            });
        }

        async function updateUIForUser(user) {
            console.log('Обновление интерфейса для защищенного пользователя:', user.uid);
            
            const displayName = user.displayName || 'Защищенный пользователь';
            const email = user.email || 'Email скрыт';
            
            // Обновляем хедер
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userStatus').textContent = maskEmail(email);
            
            // Обновляем сайдбар
            document.getElementById('sidebarName').textContent = displayName;
            document.getElementById('sidebarEmail').textContent = maskEmail(email);
            
            // Обновляем меню
            updateUserMenu(user);
            
            // Скрываем модалки авторизации
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('registerModal').classList.remove('show');
        }

        function updateUIForGuest() {
            console.log('Обновление интерфейса для гостя');
            
            document.getElementById('userName').textContent = 'Гость';
            document.getElementById('userStatus').textContent = 'Войти в защищенный аккаунт';
            
            document.getElementById('sidebarName').textContent = 'Гость';
            document.getElementById('sidebarEmail').textContent = 'Не авторизован';
            
            // Обновляем меню
            updateGuestMenu();
        }

        function maskEmail(email) {
            if (!email) return 'Email скрыт';
            
            const [local, domain] = email.split('@');
            if (!local || !domain) return 'Email скрыт';
            
            if (local.length <= 3) {
                return '*'.repeat(local.length) + '@' + domain;
            }
            
            const maskedLocal = local.substring(0, 3) + '*'.repeat(local.length - 3);
            return maskedLocal + '@' + domain;
        }

        function updateUserMenu(user) {
            const userMenu = document.getElementById('userMenu');
            
            userMenu.innerHTML = `
                <div class="dropdown-header" style="padding: 0.75rem 1rem;">
                    <div style="font-weight: 600;">${user.displayName || 'Пользователь'}</div>
                    <small style="color: var(--gray);">Защищенный аккаунт</small>
                </div>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="location.reload()">
                    <i class="fas fa-redo"></i>
                    <span>Обновить</span>
                </button>
                <button class="dropdown-item" id="openSupportBtn">
                    <i class="fas fa-headset"></i>
                    <span>Конфиденциальная поддержка</span>
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Выйти из защищенного аккаунта</span>
                </button>
            `;
            
            setTimeout(() => {
                document.getElementById('logoutBtn')?.addEventListener('click', signOut);
                document.getElementById('openSupportBtn')?.addEventListener('click', function() {
                    document.getElementById('userDropdown').classList.remove('show');
                    document.getElementById('supportModal').classList.add('show');
                });
            }, 100);
        }

        function updateGuestMenu() {
            const userMenu = document.getElementById('userMenu');
            
            userMenu.innerHTML = `
                <button class="dropdown-item" id="loginMenuBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Войти в защищенный аккаунт</span>
                </button>
                <button class="dropdown-item" id="registerMenuBtn">
                    <i class="fas fa-user-plus"></i>
                    <span>Создать защищенный аккаунт</span>
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" id="supportMenuBtn">
                    <i class="fas fa-headset"></i>
                    <span>Конфиденциальная поддержка</span>
                </button>
            `;
            
            setTimeout(() => {
                document.getElementById('loginMenuBtn')?.addEventListener('click', function() {
                    showLoginModal();
                    document.getElementById('userDropdown').classList.remove('show');
                });
                
                document.getElementById('registerMenuBtn')?.addEventListener('click', function() {
                    document.getElementById('userDropdown').classList.remove('show');
                    document.getElementById('registerModal').classList.add('show');
                });
                
                document.getElementById('supportMenuBtn')?.addEventListener('click', function() {
                    document.getElementById('userDropdown').classList.remove('show');
                    document.getElementById('supportModal').classList.add('show');
                });
            }, 100);
        }

        function showLoginModal() {
            document.getElementById('authModal').classList.add('show');
        }

        // ФУНКЦИИ АУТЕНТИФИКАЦИИ
        async function signInWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginError = document.getElementById('loginError');
            
            if (!email || !password) {
                loginError.textContent = 'Заполните все поля';
                loginError.style.display = 'block';
                return;
            }
            
            try {
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                showMessage('Успешный вход в защищенный аккаунт!', 'success');
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                loginError.style.display = 'none';
                
            } catch (error) {
                console.error('Ошибка защищенного входа:', error);
                
                let errorMessage = 'Ошибка входа в защищенный аккаунт. ';
                if (error.code === 'auth/invalid-login-credentials') {
                    errorMessage = 'Неверный email или пароль для защищенного аккаунта';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Защищенный аккаунт не найден';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Неверный пароль для защищенного аккаунта';
                } else {
                    errorMessage += error.message;
                }
                
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            }
        }

        async function signUpWithEmail() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const privacyAgreement = document.getElementById('registerPrivacyAgreement').checked;
            const termsAgreement = document.getElementById('registerTermsAgreement').checked;
            const registerError = document.getElementById('registerError');
            
            // Валидация
            if (!username || !email || !password || !confirmPassword) {
                registerError.textContent = 'Заполните все поля';
                registerError.style.display = 'block';
                return;
            }
            
            if (username.length < 3) {
                registerError.textContent = 'Имя пользователя должно быть не менее 3 символов';
                registerError.style.display = 'block';
                return;
            }
            
            if (!privacyAgreement || !termsAgreement) {
                registerError.textContent = 'Необходимо принять все соглашения';
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                registerError.textContent = 'Пароли не совпадают';
                registerError.style.display = 'block';
                return;
            }
            
            if (password.length < 8) {
                registerError.textContent = 'Пароль должен быть не менее 8 символов';
                registerError.style.display = 'block';
                return;
            }
            
            if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/.test(password)) {
                registerError.textContent = 'Пароль должен содержать заглавные, строчные буквы, цифры и спецсимволы';
                registerError.style.display = 'block';
                return;
            }
            
            try {
                const { createUserWithEmailAndPassword, updateProfile, sendEmailVerification } = window.firebaseModules;
                
                // Создание пользователя
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Обновление профиля
                await updateProfile(userCredential.user, {
                    displayName: username
                });
                
                // Отправка email для подтверждения
                await sendEmailVerification(userCredential.user);
                
                // Создание разделенной базы данных
                await createSplitDatabase(userCredential.user.uid, {
                    username: username,
                    email: email,
                    agreements: {
                        privacy: true,
                        terms: true,
                        newsletter: true,
                        timestamp: new Date().toISOString()
                    }
                });
                
                showMessage('Защищенный аккаунт успешно создан! Проверьте email для подтверждения.', 'success');
                document.getElementById('registerModal').classList.remove('show');
                
                // Очистка формы
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerConfirmPassword').value = '';
                document.getElementById('registerPrivacyAgreement').checked = false;
                document.getElementById('registerTermsAgreement').checked = false;
                registerError.style.display = 'none';
                
            } catch (error) {
                console.error('Ошибка создания защищенного аккаунта:', error);
                
                let errorMessage = 'Ошибка создания защищенного аккаунта. ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email уже используется для другого защищенного аккаунта';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Неверный формат email';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Пароль слишком слабый для защищенного аккаунта';
                } else {
                    errorMessage += error.message;
                }
                
                registerError.textContent = errorMessage;
                registerError.style.display = 'block';
            }
        }

        async function signOut() {
            try {
                const { signOut } = window.firebaseModules;
                await signOut(auth);
                showMessage('Вы вышли из защищенного аккаунта', 'info');
            } catch (error) {
                console.error('Ошибка выхода:', error);
                showMessage('Ошибка выхода из защищенного аккаунта', 'error');
            }
        }

        // ФУНКЦИИ РАЗДЕЛЕННОЙ БАЗЫ ДАННЫХ
        async function createSplitDatabase(uid, userData) {
            try {
                const { doc, setDoc, writeBatch } = window.firebaseModules;
                const batch = writeBatch(db);
                
                // 1. Публичные данные (/users/{uid})
                const publicData = {
                    username: userData.username,
                    email: maskEmail(userData.email), // Только маскированный email
                    createdAt: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    profile: {
                        bio: '',
                        favoriteLine: ''
                    }
                };
                
                batch.set(doc(db, DATABASE_CONFIG.PUBLIC_PATH, uid), publicData);
                
                // 2. Секретные данные (/users.secret/{uid})
                const secretData = {
                    fullEmail: userData.email, // Полный email
                    uid: uid,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    personal: {
                        birthDate: '',
                        country: '',
                        phone: ''
                    },
                    security: {
                        passwordChangedAt: new Date().toISOString(),
                        twoFactorEnabled: false
                    }
                };
                
                batch.set(doc(db, DATABASE_CONFIG.SECRET_PATH, uid), secretData);
                
                // 3. Соглашения (/agreements/{uid})
                const agreementData = {
                    uid: uid,
                    email: userData.email,
                    agreements: userData.agreements,
                    history: [{
                        type: 'registration',
                        timestamp: new Date().toISOString(),
                        data: userData.agreements
                    }]
                };
                
                batch.set(doc(db, DATABASE_CONFIG.AGREEMENTS_PATH, uid), agreementData);
                
                // Выполняем все операции атомарно
                await batch.commit();
                
                console.log('Разделенная база данных создана для:', uid);
                return true;
                
            } catch (error) {
                console.error('Ошибка создания разделенной базы:', error);
                throw error;
            }
        }

        async function loadAllUserData(uid) {
            try {
                const { doc, getDoc } = window.firebaseModules;
                
                // Загружаем все три источника данных
                const [publicDoc, secretDoc, agreementDoc] = await Promise.all([
                    getDoc(doc(db, DATABASE_CONFIG.PUBLIC_PATH, uid)),
                    getDoc(doc(db, DATABASE_CONFIG.SECRET_PATH, uid)),
                    getDoc(doc(db, DATABASE_CONFIG.AGREEMENTS_PATH, uid))
                ]);
                
                // Сохраняем данные
                currentUserData = {
                    public: publicDoc.exists() ? publicDoc.data() : null,
                    secret: secretDoc.exists() ? secretDoc.data() : null,
                    agreements: agreementDoc.exists() ? agreementDoc.data() : null
                };
                
                // Обновляем интерфейс
                updateUIWithData();
                
                console.log('Все данные загружены:', currentUserData);
                return currentUserData;
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                
                // Если база не существует, создаем
                if (error.code === 'not-found' || !currentUserData.public) {
                    console.log('База не найдена, создаем...');
                    const user = auth.currentUser;
                    await createSplitDatabase(uid, {
                        username: user.displayName,
                        email: user.email,
                        agreements: {
                            privacy: true,
                            terms: true,
                            newsletter: true,
                            timestamp: new Date().toISOString()
                        }
                    });
                    return await loadAllUserData(uid);
                }
                
                return null;
            }
        }

        function updateUIWithData() {
            const data = currentUserData;
            const user = auth.currentUser;
            
            if (!data.public || !user) return;
            
            // Публичные данные
            document.getElementById('publicUsername').value = data.public.username || '';
            document.getElementById('publicEmail').value = data.public.email || maskEmail(user.email);
            document.getElementById('publicBio').value = data.public.profile?.bio || '';
            document.getElementById('publicFavoriteLine').value = data.public.profile?.favoriteLine || '';
            
            // Приватные данные
            document.getElementById('privateFullEmail').textContent = data.secret?.fullEmail || user.email || '';
            document.getElementById('newEmail').value = '';
            document.getElementById('confirmEmailPassword').value = '';
            document.getElementById('birthDate').value = data.secret?.personal?.birthDate || '';
            document.getElementById('country').value = data.secret?.personal?.country || '';
            document.getElementById('phoneNumber').value = data.secret?.personal?.phone || '';
            
            // Соглашения
            if (data.agreements) {
                document.getElementById('newsletterAgreement').checked = data.agreements.agreements?.newsletter || false;
                document.getElementById('researchAgreement').checked = data.agreements.agreements?.research || false;
            }
            
            // Таблицы базы данных
            updateDatabaseTables();
        }

        function updateDatabaseTables() {
            const data = currentUserData;
            const user = auth.currentUser;
            
            // Публичная таблица
            document.getElementById('pubUsername').textContent = data.public?.username || 'Нет данных';
            document.getElementById('pubEmail').textContent = data.public?.email || maskEmail(user?.email);
            document.getElementById('pubBio').textContent = data.public?.profile?.bio || 'Нет данных';
            
            // Секретная таблица
            document.getElementById('secEmail').textContent = data.secret?.fullEmail || user?.email || 'Нет данных';
            document.getElementById('secUid').textContent = user?.uid?.substring(0, 8) + '...' || 'Нет данных';
            document.getElementById('secCreated').textContent = data.secret?.createdAt ? 
                new Date(data.secret.createdAt).toLocaleDateString('ru-RU') : 'Нет данных';
        }

        async function savePublicData() {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const { doc, updateDoc } = window.firebaseModules;
                
                const publicData = {
                    username: document.getElementById('publicUsername').value.trim(),
                    email: maskEmail(user.email), // Всегда маскируем
                    profile: {
                        bio: document.getElementById('publicBio').value,
                        favoriteLine: document.getElementById('publicFavoriteLine').value
                    },
                    lastSeen: new Date().toISOString()
                };
                
                await updateDoc(doc(db, DATABASE_CONFIG.PUBLIC_PATH, user.uid), publicData);
                
                // Обновляем имя в Firebase Auth если изменилось
                const newUsername = document.getElementById('publicUsername').value.trim();
                if (newUsername && newUsername !== user.displayName) {
                    const { updateProfile } = window.firebaseModules;
                    await updateProfile(user, {
                        displayName: newUsername
                    });
                    
                    // Обновляем отображение
                    document.getElementById('userName').textContent = newUsername;
                    document.getElementById('sidebarName').textContent = newUsername;
                }
                
                // Обновляем кэш
                currentUserData.public = { ...currentUserData.public, ...publicData };
                
                showMessage('Публичные данные сохранены', 'success');
                
            } catch (error) {
                console.error('Ошибка сохранения публичных данных:', error);
                showMessage('Ошибка сохранения публичных данных', 'error');
            }
        }

        async function savePrivateData() {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const { doc, updateDoc } = window.firebaseModules;
                
                const secretData = {
                    personal: {
                        birthDate: document.getElementById('birthDate').value,
                        country: document.getElementById('country').value,
                        phone: document.getElementById('phoneNumber').value
                    },
                    lastUpdated: new Date().toISOString()
                };
                
                await updateDoc(doc(db, DATABASE_CONFIG.SECRET_PATH, user.uid), secretData);
                
                // Обновляем кэш
                if (currentUserData.secret) {
                    currentUserData.secret = { 
                        ...currentUserData.secret, 
                        ...secretData,
                        personal: { ...currentUserData.secret.personal, ...secretData.personal }
                    };
                }
                
                showMessage('Конфиденциальные данные сохранены', 'success');
                
            } catch (error) {
                console.error('Ошибка сохранения конфиденциальных данных:', error);
                showMessage('Ошибка сохранения конфиденциальных данных', 'error');
            }
        }

        async function saveAgreements() {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const { doc, updateDoc, arrayUnion } = window.firebaseModules;
                
                const agreements = {
                    newsletter: document.getElementById('newsletterAgreement').checked,
                    research: document.getElementById('researchAgreement').checked,
                    updatedAt: new Date().toISOString()
                };
                
                const updateData = {
                    agreements: agreements,
                    history: arrayUnion({
                        type: 'update',
                        timestamp: new Date().toISOString(),
                        data: agreements
                    })
                };
                
                await updateDoc(doc(db, DATABASE_CONFIG.AGREEMENTS_PATH, user.uid), updateData);
                
                // Обновляем кэш
                if (currentUserData.agreements) {
                    currentUserData.agreements.agreements = agreements;
                }
                
                showMessage('Соглашения сохранены', 'success');
                
            } catch (error) {
                console.error('Ошибка сохранения соглашений:', error);
                showMessage('Ошибка сохранения соглашений', 'error');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            const user = auth.currentUser;
            if (!user || !user.email) {
                showMessage('Пользователь не найден', 'error');
                return;
            }
            
            // Валидация
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showMessage('Заполните все поля', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showMessage('Новые пароли не совпадают', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showMessage('Пароль должен быть не менее 8 символов', 'error');
                return;
            }
            
            if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/.test(newPassword)) {
                showMessage('Пароль должен содержать заглавные, строчные буквы, цифры и спецсимволы', 'error');
                return;
            }
            
            try {
                const { reauthenticateWithCredential, EmailAuthProvider, updatePassword } = window.firebaseModules;
                
                // Реаутентификация
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                
                // Смена пароля
                await updatePassword(user, newPassword);
                
                // Обновление в секретной базе
                const { doc, updateDoc } = window.firebaseModules;
                await updateDoc(doc(db, DATABASE_CONFIG.SECRET_PATH, user.uid), {
                    'security.passwordChangedAt': new Date().toISOString()
                });
                
                showMessage('Пароль успешно изменён!', 'success');
                
                // Очищаем форму
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
            } catch (error) {
                console.error('Ошибка смены пароля:', error);
                
                let errorMessage = 'Ошибка смены пароля. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Неверный текущий пароль';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Требуется повторная авторизация';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        async function changeEmail() {
            const newEmail = document.getElementById('newEmail').value;
            const password = document.getElementById('confirmEmailPassword').value;
            
            const user = auth.currentUser;
            if (!user || !user.email) {
                showMessage('Пользователь не найден', 'error');
                return;
            }
            
            if (!newEmail || !password) {
                showMessage('Заполните все поля', 'error');
                return;
            }
            
            if (newEmail === user.email) {
                showMessage('Новый email совпадает с текущим', 'warning');
                return;
            }
            
            try {
                const { reauthenticateWithCredential, EmailAuthProvider, updateEmail } = window.firebaseModules;
                
                // Реаутентификация
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);
                
                // Смена email в Firebase Auth
                await updateEmail(user, newEmail);
                
                // Обновление в базах данных
                const { doc, updateDoc, writeBatch } = window.firebaseModules;
                const batch = writeBatch(db);
                
                // Обновляем публичную базу (маскированный email)
                batch.update(doc(db, DATABASE_CONFIG.PUBLIC_PATH, user.uid), {
                    email: maskEmail(newEmail)
                });
                
                // Обновляем секретную базу (полный email)
                batch.update(doc(db, DATABASE_CONFIG.SECRET_PATH, user.uid), {
                    fullEmail: newEmail,
                    lastUpdated: new Date().toISOString()
                });
                
                // Обновляем соглашения
                batch.update(doc(db, DATABASE_CONFIG.AGREEMENTS_PATH, user.uid), {
                    email: newEmail
                });
                
                await batch.commit();
                
                showMessage('Email успешно изменён! Проверьте новый email для подтверждения.', 'success');
                
                // Очищаем форму
                document.getElementById('newEmail').value = '';
                document.getElementById('confirmEmailPassword').value = '';
                
            } catch (error) {
                console.error('Ошибка смены email:', error);
                
                let errorMessage = 'Ошибка смены email. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Неверный пароль';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email уже используется';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Неверный формат email';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        async function loadSectionData(section) {
            const user = auth.currentUser;
            if (!user) return;
            
            switch (section) {
                case 'public':
                    // Данные уже загружены
                    break;
                case 'private':
                    // Обновляем email в форме
                    document.getElementById('privateFullEmail').textContent = 
                        currentUserData.secret?.fullEmail || user.email;
                    break;
                case 'agreements':
                    await loadAgreementsHistory(user.uid);
                    break;
                case 'database':
                    updateDatabaseTables();
                    break;
            }
        }

        async function loadAgreementsHistory(uid) {
            try {
                const historyContainer = document.getElementById('agreementsHistory');
                
                if (!currentUserData.agreements?.history) {
                    historyContainer.innerHTML = '<p style="color: var(--gray);">История соглашений не найдена</p>';
                    return;
                }
                
                let html = '';
                currentUserData.agreements.history.forEach((item, index) => {
                    const date = new Date(item.timestamp).toLocaleString('ru-RU');
                    html += `
                        <div style="padding: 0.75rem; background: white; border-radius: var(--radius-md); margin-bottom: 0.5rem;">
                            <div style="font-weight: 600;">${item.type === 'registration' ? 'Регистрация' : 'Обновление'}</div>
                            <div style="font-size: 0.85rem; color: var(--gray);">${date}</div>
                            ${item.data ? `
                                <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                                    ${item.data.newsletter ? '✓ Рассылка' : '✗ Рассылка'} | 
                                    ${item.data.research ? '✓ Исследования' : '✗ Исследования'}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                historyContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки истории соглашений:', error);
            }
        }

        function exportUserData() {
            const user = auth.currentUser;
            if (!user) return;
            
            const exportData = {
                exportedAt: new Date().toISOString(),
                userId: user.uid,
                publicData: currentUserData.public,
                agreements: currentUserData.agreements
                // Секретные данные не экспортируются!
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `metro-new-data-${user.uid}-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('Данные экспортированы (без конфиденциальной информации)', 'success');
        }

        async function syncDatabases() {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                await loadAllUserData(user.uid);
                showMessage('Базы данных синхронизированы', 'success');
            } catch (error) {
                console.error('Ошибка синхронизации:', error);
                showMessage('Ошибка синхронизации баз данных', 'error');
            }
        }

        function clearLocalCache() {
            localStorage.removeItem('lastActivity');
            localStorage.removeItem('userAgent');
            showMessage('Локальный кэш очищен', 'info');
        }

        function showConfirm(title, message, action) {
            document.getElementById('confirmTitle').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${title}`;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmActionBtn').dataset.action = title;
            window.pendingAction = action;
            document.getElementById('confirmModal').classList.add('show');
        }

        function showMessage(text, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${text}</span>
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    messageEl.remove();
                }, 300);
            }, 3000);
        }

        // Правила безопасности для Firebase (добавьте в консоль)
        window.getFirebaseRules = function() {
            return `
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Публичные данные - читать могут все, писать только владелец
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Секретные данные - только владелец
    match /users.secret/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Соглашения - только владелец и администрация
    match /agreements/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
            `;
        };

        // Экспорт для отладки
        window.secureSystem = {
            getCurrentData: () => currentUserData,
            getDatabaseStructure: () => DATABASE_CONFIG,
            testMaskEmail: (email) => maskEmail(email),
            getFirebaseRules: window.getFirebaseRules
        };
    </script>
</body>
</html>
